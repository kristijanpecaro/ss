(function(factory){if(typeof define==='function'&&define.amd){define(['jquery'],factory);}else if(typeof module==='object'&&typeof module.exports==='object'){factory(require('jquery'));}else{factory(jQuery);}}(function($){$.timeago=function(timestamp){if(timestamp instanceof Date){return inWords(timestamp);}else if(typeof timestamp==="string"){return inWords($.timeago.parse(timestamp));}else if(typeof timestamp==="number"){return inWords(new Date(timestamp));}else{return inWords($.timeago.datetime(timestamp));}};var $t=$.timeago;$.extend($.timeago,{settings:{refreshMillis:60000,allowPast:true,allowFuture:false,localeTitle:false,cutoff:0,autoDispose:true,strings:{prefixAgo:null,prefixFromNow:null,suffixAgo:"ago",suffixFromNow:"from now",inPast:'any moment now',seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years",wordSeparator:" ",numbers:[]}},inWords:function(distanceMillis){if(!this.settings.allowPast&&!this.settings.allowFuture){throw'timeago allowPast and allowFuture settings can not both be set to false.';}
var $l=this.settings.strings;var prefix=$l.prefixAgo;var suffix=$l.suffixAgo;if(this.settings.allowFuture){if(distanceMillis<0){prefix=$l.prefixFromNow;suffix=$l.suffixFromNow;}}
if(!this.settings.allowPast&&distanceMillis>=0){return this.settings.strings.inPast;}
var seconds=Math.abs(distanceMillis)/ 1000;var minutes=seconds / 60;var hours=minutes / 60;var days=hours / 24;var years=days / 365;function substitute(stringOrFunction,number){var string=$.isFunction(stringOrFunction)?stringOrFunction(number,distanceMillis):stringOrFunction;var value=($l.numbers&&$l.numbers[number])||number;return string.replace(/%d/i,value);}
var words=seconds<45&&substitute($l.seconds,Math.round(seconds))||seconds<90&&substitute($l.minute,1)||minutes<45&&substitute($l.minutes,Math.round(minutes))||minutes<90&&substitute($l.hour,1)||hours<24&&substitute($l.hours,Math.round(hours))||hours<42&&substitute($l.day,1)||days<30&&substitute($l.days,Math.round(days))||days<45&&substitute($l.month,1)||days<365&&substitute($l.months,Math.round(days / 30))||years<1.5&&substitute($l.year,1)||substitute($l.years,Math.round(years));var separator=$l.wordSeparator||"";if($l.wordSeparator===undefined){separator=" ";}
return $.trim([prefix,words,suffix].join(separator));},parse:function(iso8601){var s=$.trim(iso8601);s=s.replace(/\.\d+/,"");s=s.replace(/-/,"/").replace(/-/,"/");s=s.replace(/T/," ").replace(/Z/," UTC");s=s.replace(/([\+\-]\d\d)\:?(\d\d)/," $1$2");s=s.replace(/([\+\-]\d\d)$/," $100");return new Date(s);},datetime:function(elem){var iso8601=$t.isTime(elem)?$(elem).attr("datetime"):$(elem).attr("title");return $t.parse(iso8601);},isTime:function(elem){return $(elem).get(0).tagName.toLowerCase()==="time";}});var functions={init:function(){functions.dispose.call(this);var refresh_el=$.proxy(refresh,this);refresh_el();var $s=$t.settings;if($s.refreshMillis>0){this._timeagoInterval=setInterval(refresh_el,$s.refreshMillis);}},update:function(timestamp){var date=(timestamp instanceof Date)?timestamp:$t.parse(timestamp);$(this).data('timeago',{datetime:date});if($t.settings.localeTitle){$(this).attr("title",date.toLocaleString());}
refresh.apply(this);},updateFromDOM:function(){$(this).data('timeago',{datetime:$t.parse($t.isTime(this)?$(this).attr("datetime"):$(this).attr("title"))});refresh.apply(this);},dispose:function(){if(this._timeagoInterval){window.clearInterval(this._timeagoInterval);this._timeagoInterval=null;}}};$.fn.timeago=function(action,options){var fn=action?functions[action]:functions.init;if(!fn){throw new Error("Unknown function name '"+action+"' for timeago");}
this.each(function(){fn.call(this,options);$(this).addClass("loadedAgo");});return this;};function refresh(){var $s=$t.settings;if($s.autoDispose&&!$.contains(document.documentElement,this)){$(this).timeago("dispose");return this;}
var data=prepareData(this);if(!isNaN(data.datetime)){if($s.cutoff===0||Math.abs(distance(data.datetime))<$s.cutoff){$(this).text(inWords(data.datetime));}else{if($(this).attr('title').length>0){$(this).text($(this).attr('title'));}}}
return this;}
function prepareData(element){element=$(element);if(!element.data("timeago")){element.data("timeago",{datetime:$t.datetime(element)});var text=$.trim(element.text());if($t.settings.localeTitle){element.attr("title",element.data('timeago').datetime.toLocaleString());}else if(text.length>0&&!($t.isTime(element)&&element.attr("title"))){element.attr("title",text);}}
return element.data("timeago");}
function inWords(date){return $t.inWords(distance(date));}
function distance(date){return(new Date().getTime()-date.getTime());}
document.createElement("abbr");document.createElement("time");}));;
'use strict';var chatbox=chatbox||{};!function($,dtill,i){var exp;var r;var sentences;var color;var test;chatbox=(exp=/\bhttps?:\/\/\S+/gi,r=ips.getSetting("lazyLoadEnabled")?ips.getSetting("blankImg"):null,sentences={},color=function(s,n){return(Array(n=n||2).join("0")+s).slice(-n);},test=function(v,l,h){if(v.length<=l){return v;}
var j=l-(h=h||"...").length;return v.substr(0,Math.ceil(j / 2))+h+v.substr(v.length-Math.floor(j / 2));},{parseContent:function(content,attrName,attrValue){var o=[];var begin=0;return content=content.replace(exp,function(query){query=query.replace(/&amp;/g,"&");var end=content.indexOf(query,begin);var resizewidth=ips.templates.render("chatbox.parseURL",{url:query,text:test(query,60)});if("src='"!==content.substring(end,end-5)&&'srcset="'!==content.substring(end,end-8)){var innerNodeName=query.substr(query.lastIndexOf(".")+1).toLowerCase();if(-1!=query.indexOf("/giphy.gif")||-1!==jQuery.inArray(innerNodeName,["jpg","jpeg","jpe","png","gif","webp"])){if("twemoji"==ips.getSetting("emoji_style")&&-1!=query.indexOf("twemoji@")){resizewidth="<img class='chatboxEmoji' src='"+query+"'>";}else{if(attrName.allow_img){if(1!=ips.getSetting("bim_giphy_play")&&-1!=query.indexOf("/giphy.gif")){var image=query.split("/giphy.gif")[0]+"/giphy.gif";var u=image.replace("/giphy.gif","/giphy_s.gif");var m=ips.templates.render("chatbox.parseGiphy",{gif:image,still:u,blankImage:r});}else{m=ips.templates.render("chatbox.parseImage",{url:query,blankImage:r});}
o.push(m);resizewidth="";}}}else{if(-1!==jQuery.inArray(innerNodeName,["mp3","wav"])){if(attrName.allow_audio){var h=query.indexOf("voice_memo.mp3")>-1;o.push(ips.templates.render("chatbox.parseAudio",{url:query,type:"wav"==innerNodeName?"audio/wav":"audio/mpeg",isMemo:h}));resizewidth="";}}else{if(-1!==jQuery.inArray(innerNodeName,["mp4","ogg","webm"])){if(attrName.allow_video){o.push(ips.templates.render("chatbox.parseVideo",{source:"html5",play:query,blankImage:r,html5:true}));resizewidth="";}}else{if((query.indexOf("youtube.com")>=0||query.indexOf("youtu.be")>=0)&&attrName.allow_video){var cache_message=query.split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/|\/shorts\/)/);var CAPTURE_ID=void 0!==cache_message[2]?cache_message[2].split(/[^0-9a-z_\-]/i)[0]:cache_message[0];o.push(ips.templates.render("chatbox.parseVideo",{source:"youtube",isShorts:query.indexOf("/shorts/")>0,url:query,play:"//www.youtube.com/embed/"+CAPTURE_ID+"?autoplay=1",id:CAPTURE_ID,img:"https://img.youtube.com/vi/"+CAPTURE_ID+"/mqdefault.jpg",blankImage:r,html5:false}));resizewidth="";}}}}}
return begin=end+query.length,resizewidth;}),chatbox.emoji.getEmoji(function(t){var k;for(k in t){var i=0;for(;i<t[k].length;i++){if("custom-"==t[k][i].code.substr(0,7)){var originalBaseURL=ips.utils.escapeRegexp(t[k][i].name);var reg=RegExp("(^|\\s)"+(originalBaseURL=originalBaseURL.replace("<","&lt;").replace(">","&gt;"))+"(\\s|$)","gi");for(;content.match(reg);){content=content.replace(reg,"$1"+chatbox.emoji.emojiImage(t[k][i].code,true)+"$2");}}}}}),o.length>0&&(content=content+" <div class='mediaItems'>",$.each(o,function(canCreateDiscussions,pagestr){content=content+pagestr;}),content=content+"</div>"),content;},escapeHTML:function(text){var description=document.createElement("div");return description.appendChild(document.createTextNode(text)),description.innerHTML;},mention:function(user,message){var index=$(user.currentTarget).data("member");if($(user.currentTarget).closest(".chatboxContainer").hasClass("chatboxConPopup")){var $collectionClass=$(user.currentTarget).closest(".chatboxContainer").attr("data-conID");var $sharepreview=$(".convo_"+$collectionClass);}else{$collectionClass=$(user.currentTarget).closest(".chatboxContainer").attr("data-roomID");$sharepreview=$(user.currentTarget).closest(".room_"+$collectionClass);}
if(message){if($sharepreview.find("#cke_chatMSG_"+$collectionClass).is(":visible")){var editor=CKEDITOR.instances["chatMSG_"+$collectionClass];var s=$(user.currentTarget).data("url");var boundsString=$(user.currentTarget).data("ipshover-target");var c=$(user.currentTarget).data("id");if(parseInt(c)>0){var node=null;(node=new CKEDITOR.dom.element("span")).renameNode("a");node.setAttribute("href",s);node.setAttribute("contenteditable","false");node.setAttribute("data-ipsHover","");node.setAttribute("data-ipsHover-target",boundsString);node.setAttribute("data-mentionid",c);node.setHtml("@"+index);editor.insertElement(node);editor.insertHtml(" ");}else{editor.insertHtml("@"+index+" ");}}}else{var selectedCancerStudy;var fakeInputElement=$sharepreview.find(".chatInput");selectedCancerStudy=fakeInputElement.val().length>0?fakeInputElement.val()+" @"+index:"@"+index;fakeInputElement.focus().val(selectedCancerStudy+" ");}},invertColor:function(src,dst){if(0===src.indexOf("#")){src=src.slice(1);}
var j=src+"_"+dst;if(sentences[j]){return sentences[j];}
if(3===src.length){src=src[0]+src[0]+src[1]+src[1]+src[2]+src[2];}
src.length;var red=parseInt(src.slice(0,2),16);var green=parseInt(src.slice(2,4),16);var i=parseInt(src.slice(4,6),16);if(dst){return sentences[j]=.299*red+.587*green+.114*i>150?"202020":"FFFFFF",sentences[j];}
red=(255-red).toString(16);green=(255-green).toString(16);i=(255-i).toString(16);var x=color(red)+color(green)+color(i);return sentences[j]=x,sentences[j];},initCleanEditor:function(t){var e=t.find('[data-action="uploadIMG"]');if(e.length>0){var overlayMatch=e.attr("class");var shadowW=t.width()-(e.position().left+e.outerWidth());if(t.hasClass("inGlobalChat")){shadowW=shadowW-2;}
var $list=t.find(".ipsAttachment_dropZone");$list.find('[data-action="uploadFile"]').addClass(overlayMatch).removeClass("ipsButton_primary").html(e.html());$list.css({right:shadowW,opacity:1});e.css("visibility","hidden");t.find(".ipsAttachment_fileList").insertAfter($list);}},isExternal:function(url){var e=url.match(/^([^:\/?#]+:)?(?:\/\/([^\/?#]*))?([^?#]+)?(\?[^#]*)?(#.*)?/);return"string"==typeof e[1]&&!!(e[1].length>0)&&e[1].toLowerCase()!==location.protocol||"string"==typeof e[2]&&!!(e[2].length>0)&&e[2].replace(RegExp(":("+{"http:":80,"https:":443}[location.protocol]+")?$"),"")!==location.host;},initTimeago:function(){if(1==ips.getSetting("chatbox_timeago")){$.timeago.settings.strings={prefixAgo:null,prefixFromNow:null,suffixAgo:"",suffixFromNow:"from now",seconds:ips.getString("chatbox_time_just_now"),minute:ips.getString("chatbox_time_1_minute"),minutes:ips.getString("chatbox_time_x_minutes"),hour:ips.getString("chatbox_time_1_hour"),hours:ips.getString("chatbox_time_x_hours"),day:ips.getString("chatbox_time_1_day"),days:ips.getString("chatbox_time_x_days"),month:ips.getString("chatbox_time_1_month"),months:ips.getString("chatbox_time_x_months"),year:ips.getString("chatbox_time_1_year"),years:ips.getString("chatbox_time_x_years"),wordSeparator:" ",numbers:[]};}}});String.prototype.startsWith=function(substring){return 0===this.lastIndexOf(substring,0);};}(jQuery,_);;
'use strict';!function($,dtill,canCreateDiscussions){ips.controller.register("bim.chatbox.startChat",{lmn1:false,initialize:function(){this.on("click",'[data-action="startChat"]',this.startChat);},startChat:function(event){if(this.lmn1||0==$(".chatBar").length){return false;}
this.lmn1=true;var e=$(event.currentTarget).attr("data-memberID");var o=this;return ips.getAjax()(ips.getSetting("baseURL")+"index.php?app=chatbox&module=conversation&controller=main&do=openConversation",{data:{memberID:e},type:"post"}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{var e=$(".convoTab_chats_content");if(e.find(".convoRow_"+response.conID).length>0){e.find(".convoRow_"+response.conID).click();}else{var o=ips.templates.render("chatbox.newcon.temp",{id:response.conID});e.append(o);$(document).trigger("contentChange",[$("#convoIframe")]);e.find(".convoRow_"+response.conID).click();}
e.find(".tempCon.convoRow_"+response.conID).remove();}}).always(function(canCreateDiscussions){o.lmn1=false;}),false;}});}(jQuery,_);;
ï»¿;(function($,_,undefined){"use strict";ips.controller.register('bim.chatbox.editor',{_updateEditor:null,_containerID:null,_container:null,_editorName:null,_useEnter:false,_editorHeight:0,_instanceReady:false,initialize:function(){this.setup();this.on('fileAdded',this.resizeBar);this.on('fileDeleted',this.resizeBar);this._updateEditor=setInterval(_.bind(this.updateEditor,this),500);},setup:function(){if(this.scope.hasClass('chatboxConPopup')){this._containerID=this.scope.attr('data-conID');this._container=$('.convo_'+this._containerID);this._editorName='chatCON_'+this._containerID;}
else{this._containerID=this.scope.attr('data-roomID');this._container=$('.room_'+this._containerID);this._editorName='chatMSG_'+this._containerID;}
this._useEnter=this.scope.attr('data-useEnter')==1?true:false;},updateEditor:function(){var self=this;var editor=null;try{editor=CKEDITOR.instances[this._editorName];}
catch(err){return;}
if(editor){editor.on('instanceReady',function(){editor.setData('');ips.utils.db.remove('editorSave',editor.config.ipsAutoSaveKey);if(!self._instanceReady){self._instanceReady=true;}});editor.on('change',function(){if(self._editorHeight!=self._container.find('#cbCKEditor').height()){self.resizeBar();self._editorHeight=self._container.find('#cbCKEditor').height();}});if(self._useEnter){editor.on('key',function(ev){if(ev.data.keyCode==13){ev.cancel();self._container.find('#cbCKEditor').find('form').submit();}});}
if(self._instanceReady){if(self.scope.find('#cbCKEditor #cbDonateBtn')){var elDonate=self.scope.find('#cbCKEditor #cbDonateBtn').detach();self.scope.find('.cke_toolbar_end').prepend(elDonate);elDonate.show();}
clearInterval(self._updateEditor);}}},resizeBar:function(){$('.chatBar').trigger('resizeBar');},});}(jQuery,_));;
;(function($,_,undefined){"use strict";ips.controller.mixin('bim.chatbox.emoji','core.global.editor.emoticons',true,function(){if(ips.getSetting('chatbox_no_emoji')!=1){this.before('insertEmoji',function(e){var popup=$(e.currentTarget).closest('#chatboxEmoji_menu');if(popup.length>0){var name=popup.attr('data-btnID').split('_');if(name[0]=="room"||name[0]=="con"){var emo=null;var type=$(e.currentTarget).attr('data-emoji');if(type.indexOf('custom-')>=0){emo=$(e.currentTarget).find('img').attr('title');}
else{var ipsEmoji=$(e.currentTarget).find('.ipsEmoji');if(ipsEmoji.attr('src')&&ipsEmoji.attr('src')!=undefined){emo=ipsEmoji.attr('alt');}else{emo=$(e.currentTarget).find('.ipsEmoji').html();}}
var container=name[0]=="room"?$('.room_'+name[2]):$('.convo_'+name[2]);var inputEl=container.find('.chatInput');inputEl.val(inputEl.val()+" "+emo);ips.utils.emoji.logUse(type);}}});}});ips.controller.register('chatbox.emoticons',{initialize:function(){this.on('click','[data-emoji]',this.insertEmoji);this.on('menuItemSelected','[data-role="categoryTrigger"]',this.changeCategory);chatbox.emoji.getEmoji(function(emoji,categories){setTimeout(function(){this._buildEmoji(emoji,null,categories);}.bind(this),100);}.bind(this));},insertEmoji:function(e){var popup=$(e.currentTarget).closest('#chatboxEmoji_menu');var name=popup.attr('data-btnID').split('_');var container=name[0]=="room"?$('.room_'+name[2]):$('.convo_'+name[2]);var inputEl=container.find('.chatInput');inputEl.val(inputEl.val()+" "+$(e.currentTarget).find('img').attr('title'));ips.utils.emoji.logUse($(e.currentTarget).attr('data-emoji'));},_buildEmoji:function(emoji,search,categories){var finalHtml='';var categoryHtml='';var pos=0;var emojiForThisRow='';var menuContent=[];if(!search&&ips.utils.cookie.get('recentEmoji')){var recentlyUsed=ips.utils.cookie.get('recentEmoji').split(',');var newRecentlyUsed=[];if(recentlyUsed.length){for(var i=0;i<recentlyUsed.length;i++){var displayHtml=chatbox.emoji.preview(recentlyUsed[i]);if(displayHtml){newRecentlyUsed.push(recentlyUsed[i]);emojiForThisRow+=ips.templates.render('core.editor.emoji',{display:displayHtml,name:null,code:recentlyUsed[i]});if(newRecentlyUsed.length==8||newRecentlyUsed.length==16){categoryHtml+=ips.templates.render('core.editor.emoticonRow',{emoticons:emojiForThisRow});emojiForThisRow='';}}}
if(emojiForThisRow){categoryHtml+=ips.templates.render('core.editor.emoticonRow',{emoticons:emojiForThisRow});}
if(categoryHtml){finalHtml+=ips.templates.render('core.editor.emoticonCategory',{title:ips.getString('emoji-category-recent'),categoryID:category,emoticons:categoryHtml});categoryHtml='';emojiForThisRow='';}}
if(newRecentlyUsed!=recentlyUsed){ips.utils.cookie.set('recentEmoji',newRecentlyUsed.join(','),true);}}
for(var i in categories){var category=categories[i];var categoryCount=0;for(var i=0;i<emoji[category].length;i++){var codeToUse=emoji[category][i].code;emojiForThisRow+=ips.templates.render('core.editor.emoji',{display:chatbox.emoji.preview(codeToUse),name:ips.haveString('emoji-'+emoji[category][i].name)?ips.getString('emoji-'+emoji[category][i].name):emoji[category][i].name,code:codeToUse});pos++;categoryCount++;if(pos==8){categoryHtml+=ips.templates.render('core.editor.emoticonRow',{emoticons:emojiForThisRow});pos=0;emojiForThisRow='';}}
if(!search){if(pos){categoryHtml+=ips.templates.render('core.editor.emoticonRow',{emoticons:emojiForThisRow});}
if(categoryHtml){var categoryTitle=emoji[category][0].categoryName;finalHtml+=ips.templates.render('core.editor.emoticonCategory',{title:categoryTitle,categoryID:category,emoticons:categoryHtml});categoryHtml='';pos=0;emojiForThisRow='';menuContent.push(ips.templates.render('core.editor.emoticonMenu',{title:categoryTitle,count:categoryCount,categoryID:category}));}}}
$(this.scope).find('[data-role="categoryTrigger"]').show();$(this.scope).find('[data-role="categoryMenu"]').html(menuContent.join(''));this.scope.find('.ipsMenu_innerContent').html(finalHtml);var replaceEmojiInCategory=function(category){var emoji=category.querySelectorAll('img[data-src]');_.each(emoji,function(img){img.setAttribute('src',img.getAttribute('data-src'));img.addEventListener('load',emojiLoaded);});};var emojiLoaded=function(e){e.target.removeAttribute('data-loading');};this.scope.find('.ipsMenu_innerContent .ipsEmoticons_category').each(function(){ips.utils.lazyLoad.observe(this,{preloadCallback:$.noop,imgLoadedCallback:$.noop,loadedCallback:$.noop,loadCallback:function(category){replaceEmojiInCategory(category);var nextCategory=$(this).next('.ipsEmoticons_category');if(nextCategory.length){replaceEmojiInCategory(nextCategory.get(0));}}},{rootMargin:'350px'});});},changeCategory:function(e,data){this.scope.find('.ipsMenu_innerContent').scrollTop(this.scope.find('.ipsMenu_innerContent').scrollTop()+this.scope.find('[data-categoryid="'+data.selectedItemID+'"]').position().top-85);}});ips.createModule('chatbox.emoji',function(){var _emoji=null,_categories=null,_ajax=null,_callbacks=[],getEmoji=function(callback){if(this._emoji&&this._categories){callback(this._emoji,this._categories);return;}
var baseURL=ips.getSetting('baseURL');var storage=ips.utils.db.get('chatboxEmoji',baseURL+'-'+ips.getSetting('emoji_cache'));var categories=ips.utils.db.get('chatboxEmojiCategories',baseURL+'-'+ips.getSetting('emoji_cache'));if(storage&&categories){this._emoji=storage;callback(storage,categories);}else{ips.utils.db.removeByType('chatboxEmoji');if(callback){if(!this._callbacks){this._callbacks=[];}
this._callbacks.push(callback);}
if(this._ajax&&this._ajax.abort){this._ajax.abort();}
this._ajax=ips.getAjax()(ips.getSetting('baseURL')+'index.php?app=chatbox&module=chatbox&controller=chatbox&do=emoji').done(function(emoji){this._emoji={};this._categories=[];for(var category in emoji){var categoryName=emoji[category].category;this._categories.push(categoryName);this._emoji[categoryName]=[];for(var i=0;i<emoji[category].emoji.length;i++){emoji[category].emoji[i].shortNames.push(ips.getString('emoji-'+emoji[category].emoji[i].name));this._emoji[categoryName].push(emoji[category].emoji[i]);}}
ips.utils.db.set('chatboxEmoji',ips.getSetting('baseURL')+'-'+ips.getSetting('emoji_cache'),this._emoji);ips.utils.db.set('chatboxEmojiCategories',ips.getSetting('baseURL')+'-'+ips.getSetting('emoji_cache'),this._categories);if(this._callbacks){for(var i=0;i<this._callbacks.length;i++){this._callbacks[i](this._emoji,this._categories);}}}.bind(this));}},emojiImage=function(codeToUse){var parts=codeToUse.split('-');if(_.isUndefined(this._emoji[parts[1]])){return null;}
for(var i=0;i<this._emoji[parts[1]].length;i++){if(this._emoji[parts[1]][i].code==codeToUse){var imgTag='<img src="'+this._emoji[parts[1]][i].image+'" loading="lazy"';imgTag+='title="'+this._emoji[parts[1]][i].name+'" alt="'+this._emoji[parts[1]][i].name+'"';if(this._emoji[parts[1]][i].image2x){imgTag+=' srcset="'+this._emoji[parts[1]][i].image2x+' 2x"';}
if(parseInt(this._emoji[parts[1]][i].width)&&parseInt(this._emoji[parts[1]][i].height)){imgTag+=' width="'+this._emoji[parts[1]][i].width+'" height="'+this._emoji[parts[1]][i].height+'"';}
imgTag+=' data-emoticon="true">';return imgTag;}}
return null;},preview=function(code){return this.emojiImage(code);};return{getEmoji:getEmoji,emojiImage:emojiImage,preview:preview,};});}(jQuery,_));;
;(function($,_,undefined){"use strict";ips.controller.register('bim.chatbox.ignoredUsers',{initialize:function(){this.on('click','[data-action="delUser"]',this.delUser);this.on('submit','form',this.addnew);this.scope.click();},addnew:function(e){e.preventDefault();var self=this;var form=$(e.currentTarget);ips.getAjax()(form.attr('action'),{data:form.serialize(),type:'post',bypassRedirect:true}).done(function(response){if(response.type=='error'){ips.ui.alert.show({message:response.message});}
else{self.scope.find('.cToken_close').click();var container=self.scope.find('[data-role="tableRows"]');if(container.length==0){var newCon="<div data-role='tableRows'></div>";self.scope.find('[data-resort="listResort"]').html(newCon);}
self.scope.find('[data-role="tableRows"]').prepend(response.html);}});return false;},delUser:function(e){var self=this;ips.getAjax()($(e.currentTarget).attr('href')).done(function(response){if(response.type=='error'){ips.ui.alert.show({message:response.message});}
else{$(e.currentTarget).closest('.cbIgRow').remove();}});return false;},});}(jQuery,_));;
'use strict';!function($,project,n){ips.controller.register("bim.chatbox.main",{lmn1:null,lmn2:null,lmn3:null,lmn4:null,lmn5:"",lmn6:null,lmn7:null,lmn8:null,lmn9:null,lmn10:null,lmn11:null,lmn12:true,lmn13:false,lmn14:false,lmn15:false,lmn16:false,lmn17:false,lmn18:0,lmn19:0,lmn20:0,lmn21:0,lmn22:0,lmn23:{},lmn24:null,lmn25:true,lmn26:[],initialize:function(){if(this.scope.find(".convoList").length>0){this.setup();this.on("focus","#searchMem",this.focusSearchMem);this.on("blur","#searchMem",this.blurSearchMem);this.on("click",'[data-action="closeSearch"]',this.closeSearch);this.on("click",'[data-action="openConversation"]',this.openConversation);this.on("click",'[data-action="openRoom"]',this.openRoom);this.on("click",'[data-action="createGroup"]',this.createGroup);this.on("menuItemSelected",".conOptions",this.conOptions);this.on("menuItemSelected",".msgAction",this.msgAction);this.on("click",'.convoList [data-action="toggleChat"], .convoTab [data-action="toggleChat"]',this.toggleChat);this.on("click",'[data-action="closeChat"]',this.closeChat);this.on("click",'[data-action="msgOptions"]',function(username){return chatbox.toggleControlMSG(username),false;});this.on("click",".convoTab .chat_row",function(username){chatbox.hideAllControlMSG(username);});this.on("click",'.convoTab [data-action="mention"]',this.mention);if(this.lmn6.autoload){this.scope.find(".convoTab #chatContentIframe").on("scroll",project.bind(this.autoLoad,this));}else{this.on("click",'.convoTab [data-action="loadMore"]',this.loadMore);}
this.on("click",'[data-action="convoTabChange"]',this.convoTabChange);this.on("focus",".convoTab .chatInput",this.readTab);this.on("submit",".convoTab .chatboxEditor",this.submitEditor);if(!this.lmn6.use_editor){this.on("click",'.convoTab [data-action="sendMSG"]',this.clickSubmit);this.on("keypress",".convoTab #chatInputArea textarea",this.enterSubmit);}
this.on("click",'[data-action="refresh"]',this.refresh);}
this.resizeBar();this.on(window,"resize",this.resizeBar);this.scope.bind("resizeBar",this.resizeBar);if($(".mbBottomPlayer").length&&$(".mbBottomPlayer").is(":visible")){this.scope.closest(".chatBar").css({bottom:"60px"});}
chatbox.initTimeago();this.scope.css("visibility","visible");},setup:function(){var that=this;if(that.lmn1=ips.getSetting("baseURL")+"index.php?app=chatbox&module=conversation&controller=main",that.lmn2="chatbox_tabs_"+ips.getSetting("memberID"),that.lmn3="chatbox_con_off_"+ips.getSetting("memberID"),that.lmn6=ips.getSetting("chatbox_conversations"),that._blankImage=ips.getSetting("lazyLoadEnabled")?ips.getSetting("blankImg"):null,that.lmn8=that.lmn6.soundfile?that.lmn6.soundfile:ips.getSetting("baseURL")+"applications/core/interface/sounds/notification.mp3",ips.loader.get(["core/interface/howler/howler.core.min.js"]).then(function(){that._sound=new Howl({src:that.lmn8,autoplay:false});}),that.lmn9=that.scope.find("#convoContent .convoResults"),that.lmn10=that.scope.find("#convoContent .searchResults"),ips.getSetting("chatbox_bar_mini")&&$.each(ips.getSetting("chatbox_bar_mini").split(","),function(canCreateDiscussions,p_Interval){if(ips.utils.responsive.currentIs(p_Interval.toLowerCase())){return that.lmn25=false,false;}}),that.lmn25){var elem=this.getMiniTabs();that.scope.find(".convoTab").each(function(canCreateDiscussions){var id=$(this).find(".chatboxContainer").attr("data-conID");if($(this).hasClass("minimize")&&0>elem.indexOf("c_"+id)){$(this).removeClass("minimize");}});}
that.updateChat();},syncTabs:function(){var me=this;var omessages=[];me.scope.find(".convoTab").each(function(canCreateDiscussions){if(!$(this).hasClass("minimize")){var n="convo_"+$(this).find(".chatboxContainer").attr("data-conID");if(void 0===me.lmn23[n]&&(me.lmn23[n]={lastID:0,firstLoad:1,canLoadMore:1,loadingMore:0}),"asc"==me.lmn6.sort){var val=me.lmn23[n].lastID>0?me.lmn23[n].lastID:$("."+n).find(".chat_row").last().attr("id");}else{val=me.lmn23[n].lastID>0?me.lmn23[n].lastID:$("."+n).find(".chat_row").first().attr("id");}
me.lmn23[n].lastID=val>0?val:0;omessages.push(n);}});$.each(me.lmn23,function(axis,a){if(-1===$.inArray(axis,omessages)){delete me.lmn23[axis];}});},readTab:function(event){var uboard=$(event.currentTarget).closest(".chatboxContainer").attr("data-conID");this.updateFocusTabs(uboard);},updateFocusTabs:function(e){var $sharepreview=$(".convo_"+e);var start=parseInt($sharepreview.find(".mainTitle").find(".newMsgCount").text());start=isNaN(start)?0:start;var a=0!=this.lmn19?this.lmn19.split(","):[];if(0>a.indexOf(e)&&a.unshift(e),a.length>0&&(this.lmn19=a.join(",")),start>0&&$sharepreview.find(".mainTitle").find(".newMsgCount").is(":visible")){$sharepreview.find(".mainTitle").find(".newMsgCount").hide().text();$sharepreview.find(".miniTitle").find(".newMsgCount").hide().text();$('.convoTab_chats_content .convoRow[data-conid="'+e+'"]').find(".newMsgCountTxt").hide().text();$('.convoTab_chats_content .convoRow[data-conid="'+e+'"]').removeClass("mentionMe");var end=parseInt($(".convoList .popupTitle").find(".newMsgCount").text());if((end=isNaN(end)?0:end-start)>0){$(".convoList").find(".newMsgCount").show().text(end);}else{$(".convoList").find(".newMsgCount").hide().text();}
if(this.lmn15){if(end>0){$sharepreview.find(".totalMsgCount").show().text(end);}else{$sharepreview.find(".totalMsgCount").hide().text();}}}},refresh:function(){return this.updateChat(true),false;},updateChat:function(callback){var e=this;if(e.lmn16&&!e.lmn12){return false;}
if(true==callback){e.lmn13=false;clearTimeout(e.lmn7);}
var X=e.lmn6.interval>=5E3?e.lmn6.interval:5E3;e.doUpdateChat(function(){e.lmn7=setTimeout(function(){e.updateChat(true);},X);});},doUpdateChat:function(callback){var self=this;if(self.lmn13){return false;}
self.lmn13=true;var o=true;return self.syncTabs(),this.lmn24=ips.getAjax()(self.lmn1+"&do=updateChat",{type:"POST",dataType:"json",data:{tabData:JSON.stringify(self.lmn23),roomsLastUpdate:self.lmn21,conLastMsgID:self.lmn18,activeTab:self.lmn22,focusTabs:self.lmn19,firstLoad:self.lmn12?1:0}}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{if(response.ping&&(response.ping.rooms&&($(".convoTab_rooms_content").html(self.myConvoRoomsHTML(response.ping.rooms)),$(document).trigger("contentChange",[$(".convoTab_rooms_content")]),self.lmn21=response.ping.rooms[0].lastUpdate,response.ping.rooms[0].totalRooms>0?$("#convoTab_rooms").show():$("#convoTab_rooms").hide()),response.ping.chats&&(self.lmn6.no_counter_popup&&$.each(response.ping.chats,function(userId,subscription){if($(".convo_"+subscription.id).length>0&&!$(".convo_"+subscription.id).hasClass("minimize")&&parseInt(subscription.unread)>0){response.ping.chats[userId].unread="0";self.updateFocusTabs(subscription.id);o=false;}}),$(".convoTab_chats_content").html(self.myConvoChatsHTML(response.ping.chats)),$(".convoList").hasClass("minimize")||$(".convoTab_chats_content").width($(".convoList").width()),$(document).trigger("contentChange",[$(".convoTab_chats_content")]),$(".timeago:not(.loadedAgo)").timeago(),self.lmn18=response.ping.chats[0].lastMsgID),$(".chatBar").find(".ipsOnlineStatus_online:not(.cbMemOnline)").hide(),response.ping.online&&$.each(response.ping.online,function(canCreateDiscussions,domRootID){if($(".convo_"+domRootID).length>0){$(".convo_"+domRootID).find(".ipsOnlineStatus_online").show();}
$(".convoRow_"+domRootID).find(".ipsOnlineStatus_online").show();}),self.notify(response.ping.chats)),response.tabs&&$.each(response.tabs,function(msg,result){if(void 0!==self.lmn23["convo_"+msg]){var elem=$(".convo_"+msg).find("#chatContentIframe");var $element=$(".convo_"+msg).find("#chatContent");if(self.lmn23["convo_"+msg].lastID!=result.lastID&&result.messages){if($element.find(".noMsg").remove(),"asc"==self.lmn6.sort){if(elem.scrollTop()+elem.innerHeight()-elem.prop("scrollHeight")>=-30){var indent=1;}
$element.append(self.chatRowHTML(result.messages,msg));if(self.lmn23["convo_"+msg].firstLoad&&!self.lmn6.autoload&&result.messages.length==self.lmn6.limit){$element.prepend(ips.templates.render("chatbox.loadMoreBtn"));}
$(document).trigger("contentChange",[elem]);if(1==indent||self._forceScrollDown){self.goDown(msg);}}else{$element.prepend(self.chatRowHTML(result.messages,msg));if(self.lmn23["convo_"+msg].firstLoad&&!self.lmn6.autoload&&result.messages.length==self.lmn6.limit){$element.append(ips.templates.render("chatbox.loadMoreBtn"));}
$(document).trigger("contentChange",[elem]);}
$(".timeago:not(.loadedAgo)").timeago();if(!(ips.utils.cookie.get("chatbox_is_silent")||1==ips.utils.cookie.get("chatbox_con_nosound_"+msg)||1==self.lmn23["convo_"+msg].firstLoad||self.lmn17)){self._sound.play();}
$element.find("img").imagesLoaded(function(canCreateDiscussions){self.lmn23["convo_"+msg].firstLoad=0;});self.lmn23["convo_"+msg].lastID=result.lastID;}else{$element.find(".noMsg").show();}
if(self.lmn25){$(".convo_"+msg).find(".ipsLoading").removeClass("ipsLoading");}}}),self.lmn22>0){var $btnFollow=$(".convo_"+self.lmn22).find(".noMsg");if($btnFollow.length>0&&$btnFollow.is(":hidden")){self.updateChat(true);}
$(".convo_"+self.lmn22).find(".ipsLoading").removeClass("ipsLoading");chatbox.initCleanEditor($(".convo_"+self.lmn22));}
if(response.changes){$.each(response.changes,function(domRootID,text){if(text){$("#"+domRootID+" .chatbox_msg").html(self.parseContent(text));}else{$("#"+domRootID).remove();}});}}
if("function"==typeof callback){callback();}}).fail(function(){}).always(function(canCreateDiscussions){self.lmn12=false;self._forceScrollDown=false;self.lmn13=false;self.lmn22=0;self.lmn25=false;if(o){self.lmn19=0;}}),false;},notify:function(emotes){if(emotes){var _this=this;var i=0;var a=0!=_this.lmn19?_this.lmn19.split(","):[];if(_this.lmn12){var h={};$.each(emotes,function(canCreateDiscussions,b){if(parseInt(b.unread)>0){h[b.id+""]=b.unread;}});_this.lmn20=h;}
if($.each(emotes,function(canCreateDiscussions,data){if(!(a.indexOf(data.id)>=0)){if(parseInt(data.unread)>0){if(i=i+parseInt(data.unread),$(".convo_"+data.id).find(".newMsgCount").show().text(data.unread),$('.convoTab_chats_content [data-conid="'+data.id+'"]').find(".newMsgCountTxt").show().text("("+data.unread+")"),!_this.lmn12){if($.inArray(data.id,_this.lmn26)>=0){return;}
if(_this.lmn20&&void 0!==_this.lmn20[data.id]){if(data.unread<=_this.lmn20[data.id]){return;}
_this.lmn20[data.id]=data.unread;}
if(ips.utils.cookie.get("chatbox_is_silent")||1==ips.utils.cookie.get("chatbox_con_nosound_"+data.id)||_this.lmn17||_this._sound.play(),_this.lmn15){var i=ips.templates.render("chatbox.newcon.notify",{id:data.id,title:data.title,icon:data.icon,lastMsg:data.lastMsg,inDay:data.inDay,time:data.lastMsgTime});if($("#elFlashMessage").is(":visible")&&$("#elFlashMessage").find('[data-role="newNotification"]').length){$("#elFlashMessage").find('[data-role="newNotification"]').replaceWith(i);}else{ips.ui.flashMsg.show(i,{timeout:5,position:"top",sticky:false,extraClasses:"chatboxflashMsg ipsPadding:half",escape:false});}}else{if($(".chatBar").find(".convo_"+data.id).length<=0){$('.convoTab_chats_content [data-conid="'+data.id+'"]').click();}}}}else{$(".convo_"+data.id).find(".newMsgCount").hide().text();$('.convoTab_chats_content [data-conid="'+data.id+'"]').find(".newMsgCountTxt").hide().text();}}}),i>0?$(".convoList").find(".newMsgCount").show().text(i):$(".convoList").find(".newMsgCount").hide().text(),_this.lmn15){var denomination=parseInt($(".convoList .mainTitle").find(".newMsgCount").text());if(denomination>0){$(".convoTab").find(".totalMsgCount").show().text(denomination);}else{$(".convoTab").find(".totalMsgCount").hide().text();}}}},openConversation:function(e){var options=this;var USERNAME_CLS=$(e.currentTarget).attr("data-conID");var i=$(e.currentTarget).attr("data-memberID");if(USERNAME_CLS>0){var self=$(".chatBar").find(".convo_"+USERNAME_CLS);}else{var r=$(e.currentTarget).find("strong").text();self=$(".chatBar").find('.mainTitle .conNames[title="'+r+'"]').closest(".bimChatbox");}
if(self.length>0){return self.hasClass("minimize")?self.find('.popupTitle[data-action="toggleChat"]').click():self.fadeOut(80).fadeIn(80).find(".chatInput").focus(),false;}
var $menuToggle=ips.templates.render("chatbox.blankCon",{conID:USERNAME_CLS});if("left"==ips.getSetting("chatbox_bar_pos")){$(".chatBar").append($menuToggle);}else{$(".chatBar").prepend($menuToggle);}
var $el=$(".chatBar").find(".convo_"+USERNAME_CLS);return ips.getAjax()(options.lmn1+"&do=openConversation",{data:{memberID:i,conID:USERNAME_CLS},type:"post"}).done(function(data){if("error"==data.type){ips.ui.alert.show({message:data.message});$el.remove();}else{$el.replaceWith(data.html);var element=$(".chatBar").find(".convo_"+data.conID);element.removeClass("minimize");$(document).trigger("contentChange",[element]);var s=options.getMyPopups();if(0>s.indexOf("c_"+data.conID)&&(s.unshift("c_"+data.conID),options.saveMyPopups(s.join("|"))),$(e.currentTarget).find(".newMsgCountTxt").text()){var denomination=parseInt($(e.currentTarget).find(".newMsgCountTxt").text().replace(/^\D+/g,""));element.find(".newMsgCount").text(denomination);options.updateFocusTabs(data.conID);}
options.lmn22=data.conID;options.updateChat(true);options.closeOldPopups();$(e.currentTarget).removeClass("mentionMe");options.scope.find(".convo_"+data.conID+" #chatContentIframe").on("scroll",project.bind(options.autoLoad,options));options.resizeBar();if(ips.utils.responsive.currentIs("tablet")||ips.utils.responsive.currentIs("phone")){$(".chatBar").css("width","100%");}}}),false;},createGroup:function(external_objects){var $innerblock=ips.ui.dialog.create({url:this.lmn1+"&do=createGroup",size:"narrow",title:ips.getString("chatbox_create_group_title"),forceReload:true,destructOnClose:true,callback:function(e){$(e).find("form").on("submit",function(event){return event.preventDefault(),ips.getAjax()($(event.currentTarget).attr("action"),{data:$(event.currentTarget).serialize(),type:"post",bypassRedirect:true}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{$innerblock.hide();var o=$(".convoTab_chats_content");if(o.find(".convoRow_"+response.conID).length>0){o.find(".convoRow_"+response.conID).click();}else{var a=ips.templates.render("chatbox.newcon.temp",{id:response.conID});o.append(a);$(document).trigger("contentChange",[$("#convoIframe")]);o.find(".convoRow_"+response.conID).click();}
o.find(".tempCon.convoRow_"+response.conID).remove();}}),false;});}});return $innerblock.show(),false;},configGroup:function(params,event){event.originalEvent.preventDefault();var tabname=$(params.target).closest(".chatboxContainer").attr("data-conID");var $context=$(".convo_"+tabname);return!($context.find(".cbConfigGroupForm").length>0)&&(ips.getAjax()(this.lmn1+"&do=configGroup",{type:"post",data:{conID:tabname}}).done(function(e){if("error"==e.type){ips.ui.alert.show({message:e.message});}else{$context.find("#conOptions"+tabname+"_menu").hide();$context.find("#convoWrapper").prepend(e);$(document).trigger("contentChange",[$context]);$context.find(".cbConfigGroupForm").on("submit",function(event){return event.preventDefault(),ips.getAjax()($(event.currentTarget).attr("action"),{data:$(event.currentTarget).serialize(),type:"post",bypassRedirect:true}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{$(event.currentTarget).closest("form").remove();ips.ui.flashMsg.show(ips.getString("chatbox_group_saved"));}}),false;});$context.find(".cbConfigGroupForm .formCancel").on("click",function(event){return $(event.currentTarget).closest("form").remove(),false;});}}),false);},inviteGroup:function(params,event){event.originalEvent.preventDefault();var tsvtable=this;var id=$(params.target).closest(".chatboxContainer").attr("data-conID");var $context=$(".convo_"+id);return!($context.find(".cbInviteGroupForm").length>0)&&(ips.getAjax()(tsvtable.lmn1+"&do=inviteGroup",{type:"post",data:{conID:id}}).done(function(e){if("error"==e.type){ips.ui.alert.show({message:e.message});}else{$context.find("#conOptions"+id+"_menu").hide();$context.find("#convoWrapper").prepend(e);$(document).trigger("contentChange",[$context]);$context.find(".cbInviteGroupForm").on("submit",function(event){return event.preventDefault(),ips.getAjax()($(event.currentTarget).attr("action"),{data:$(event.currentTarget).serialize(),type:"post",bypassRedirect:true}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{$(event.currentTarget).closest("form").remove();tsvtable.lmn17=true;tsvtable.lmn22=id;tsvtable.updateChat(true);tsvtable.lmn6.lastchat=$.now();}}),false;});$context.find(".cbInviteGroupForm .formCancel").on("click",function(event){return $(event.currentTarget).closest("form").remove(),false;});}}),false);},renameGroup:function(to,evt){evt.originalEvent.preventDefault();var p=this;var id=$(to.target).closest(".chatboxContainer").attr("data-conID");var $context=$(".convo_"+id);return!($context.find(".cbRenameGroupForm").length>0)&&(ips.getAjax()(p.lmn1+"&do=renameGroup",{type:"post",data:{conID:id}}).done(function(e){if("error"==e.type){ips.ui.alert.show({message:e.message});}else{$context.find("#conOptions"+id+"_menu").hide();$context.find("#convoWrapper").prepend(e);$(document).trigger("contentChange",[$context]);$context.find(".cbRenameGroupForm").on("submit",function(event){return event.preventDefault(),ips.getAjax()($(event.currentTarget).attr("action"),{data:$(event.currentTarget).serialize(),type:"post",bypassRedirect:true}).done(function(data){if("error"==data.type){ips.ui.alert.show({message:data.message});}else{$(event.currentTarget).closest("form").remove();p.updateConName(id,data.newName);p.lmn17=true;p.lmn22=id;p.updateChat(true);p.lmn6.lastchat=$.now();}}),false;});$context.find(".cbRenameGroupForm .formCancel").on("click",function(event){return $(event.currentTarget).closest("form").remove(),false;});}}),false);},updateConName:function(clazz,name){var $sharepreview=$(".convo_"+clazz);if(name&&name!=$sharepreview.find(".conNames").text()){$sharepreview.find(".conNames").attr("title",name);$sharepreview.find(".conNames").text(name);var a=$(".convoList .convoRow_"+clazz+" .conRowName");a.attr("title",name);a.find("b").text(name);}},leaveGroup:function(ctx,args){args.originalEvent.preventDefault();var main=this;var conversation=$(ctx.target).closest(".chatboxContainer").attr("data-conID");return ips.ui.alert.show({type:"confirm",message:ips.getString("chatbox_leave_con_cfr"),icon:"warn",buttons:{ok:ips.getString("chatbox_confirm_yes"),cancel:ips.getString("chatbox_confirm_cancel")},callbacks:{ok:function(){ips.getAjax()(main.lmn1+"&do=leaveGroup",{type:"post",data:{conID:conversation}}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{main.closeConversation(conversation);main.resizeBar();ips.ui.flashMsg.show(ips.getString("chatbox_you_left_group"));}});}}}),false;},usersInGroup:function(params,event){event.originalEvent.preventDefault();var studyId=$(params.target).closest(".chatboxContainer").attr("data-conID");return $(".convo_"+studyId),ips.ui.dialog.create({url:this.lmn1+"&do=usersInGroup&conID="+studyId,title:ips.getString("chatbox_group_member"),size:"narrow",forceReload:true,destructOnClose:true,destructOnClose:true,callback:function(pointSizeParam){}}).show(),false;},loadMore:function(event){var $scope=this;var o=$(event.currentTarget).closest("#chatContentIframe");var content=o.find("#chatContent");var i=o.closest(".chatboxContainer").attr("data-conID");if(0==$(".convo_"+i).length||void 0===$scope.lmn23["convo_"+i]||1==$scope.lmn23["convo_"+i].loadingMore){return false;}
$scope.lmn23["convo_"+i].loadingMore=1;var protocol="asc"==$scope.lmn6.sort?content.children(".chat_row:first").attr("id"):content.children(".chat_row:last").attr("id");return ips.getAjax()($scope.lmn1+"&do=updateOpenTabs",{type:"post",dataType:"json",data:{tabData:JSON.stringify($scope.lmn23),activeTab:i,loadMoreMode:protocol}}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{if(response.tabs[i]){if(1==response.tabs[i].noMore){$(event.currentTarget).remove();ips.ui.flashMsg.show(ips.getString("chatbox_no_older"));}else{var options=response.tabs[i].messages;if(options){if("asc"==$scope.lmn6.sort){$(event.currentTarget).after($scope.chatRowHTML(options,i));o.scrollTop(content.find("#"+protocol).position().top-50);}else{$(event.currentTarget).before($scope.chatRowHTML(options,i));}
$(document).trigger("contentChange",[o]);$(".timeago:not(.loadedAgo)").timeago();}}}}}).always(function(){$scope.lmn23["convo_"+i].loadingMore=0;}),false;},autoLoad:function(selector){if(!this.lmn6.autoload){return false;}
var $scope=this;var $elem=$(selector.currentTarget);var t=$elem.find("#chatContent");var i=$elem.closest(".chatboxContainer").attr("data-conID");if(0==$(".convo_"+i).length||void 0===$scope.lmn23["convo_"+i]||1==$scope.lmn23["convo_"+i].firstLoad||1!=$scope.lmn23["convo_"+i].canLoadMore){return false;}
if("asc"==this.lmn6.sort){if(0!=$elem.scrollTop()){return false;}
var track=t.children().first().attr("id");}else{if($elem.scrollTop()+$elem.innerHeight()<$elem[0].scrollHeight){return false;}
track=t.children().last().attr("id");}
if($elem.find("#loadMore").length<=0){var r=ips.templates.render("chatbox.loadMore");if("asc"==this.lmn6.sort){t.prepend(r);}else{t.append(r);}}
$scope.lmn23["convo_"+i].canLoadMore=0;$scope.lmn23["convo_"+i].loadingMore=1;ips.getAjax()($scope.lmn1+"&do=updateOpenTabs",{type:"post",dataType:"json",data:{tabData:JSON.stringify($scope.lmn23),activeTab:i,loadMoreMode:track}}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{if(response.tabs[i]){if(1==response.tabs[i].noMore){ips.ui.flashMsg.show(ips.getString("chatbox_no_older"));}else{var result=response.tabs[i].messages;if(result){if("asc"==$scope.lmn6.sort){t.prepend($scope.chatRowHTML(result,i));$elem.scrollTop(t.find("#"+track).position().top-50);}else{t.append($scope.chatRowHTML(result,i));}
$(document).trigger("contentChange",[$elem]);$(".timeago:not(.loadedAgo)").timeago();$scope.lmn23["convo_"+i].canLoadMore=1;}}}}
$elem.find("#loadMore").remove();}).always(function(){$scope.lmn23["convo_"+i].loadingMore=0;});},msgAction:function(d,e){(d=e?e.originalEvent:d).preventDefault();var action=$(d.target).attr("data-action");var sliderFeLineGsValue=$(d.target).attr("data-chatID");if(action){switch(action){case"edit":this.editEditor(sliderFeLineGsValue);break;case"delete":this.deleteMSG(sliderFeLineGsValue);break;case"report":this.reportMSG(sliderFeLineGsValue);}}
return false;},deleteMSG:function(value){var e=this;return ips.ui.alert.show({type:"confirm",message:ips.getString("chatbox_confirmDelete"),icon:"warn",buttons:{ok:ips.getString("chatbox_confirm_yes"),cancel:ips.getString("chatbox_confirm_cancel")},callbacks:{ok:function(){ips.getAjax()(e.lmn1+"&do=deleteMSG",{type:"post",data:{chatID:value}}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{ips.ui.flashMsg.show(ips.getString("chatbox_deleted"));e.scope.find("li#"+value).remove();}});}}}),false;},reportMSG:function(value){var n=this.scope.find("li#"+value).closest(".chatboxContainer").attr("data-conID");var $innerblock=ips.ui.dialog.create({url:ips.getSetting("baseURL")+"index.php?app=chatbox&module=conversation&controller=conversation&do=reportComment&id="+n+"&comment="+value,size:"medium",title:ips.getString("chatbox_report"),forceReload:false,destructOnClose:true,callback:function(e){$(e).find("form").on("submit",function(event){var instanceName;for(instanceName in event.preventDefault(),CKEDITOR.instances){CKEDITOR.instances[instanceName].updateElement();}
var a=$(event.currentTarget);return ips.getAjax()(a.attr("action"),{data:a.serialize(),type:"post",bypassRedirect:true}).done(function(canCreateDiscussions){ips.ui.flashMsg.show(ips.getString("chatbox_sent_report"));}).always(function(canCreateDiscussions){$innerblock.hide();}),false;});}});return $innerblock.show(),false;},toggleInputForm:function(p,rapid){var $sharepreview=$(".convo_"+p);var $code=$sharepreview.find(".chatInput");var $aidlBtn=$sharepreview.find('[data-action="sendMSG"]');if(1==rapid){this.lmn14=false;$aidlBtn.prop("disabled",false);$code.val("");if($code.closest("#chatInputArea").hasClass("expanded")){$code.closest("#chatInputArea").removeClass("expanded");$code.css("height","auto");$(".chatBar").trigger("resizeBar");}}else{this.lmn14=true;$aidlBtn.prop("disabled",true);}},getMyPopups:function(){return ips.utils.cookie.get(this.lmn2)?ips.utils.cookie.get(this.lmn2).split("|"):[];},saveMyPopups:function(ideaExample){ips.utils.cookie.set(this.lmn2,ideaExample);},getMiniTabs:function(){return ips.utils.cookie.get(this.lmn3)?ips.utils.cookie.get(this.lmn3).split("|"):[];},saveMiniTabs:function(ideaExample){ips.utils.cookie.set(this.lmn3,ideaExample);},myConvoRoomsHTML:function(args){var n="chatbox"==$("body").data("pageapp")&&"room"==$("body").data("pagecontroller");var skip="";return $.each(args,function(canCreateDiscussions,data){if(n&&data.id==$("body").data("pageid")){$(".room_"+data.id).find('[data-action="closeChat"]').click();return;}
skip=skip+ips.templates.render("chatbox.convo.list.rooms",{id:data.id,title:data.title,icon:data.icon,users:data.users});}),skip;},myConvoChatsHTML:function(args){var skip="";var servicesManager=this;return $.each(args,function(canCreateDiscussions,$scope){if(($scope.lastMsg||$scope.isGroup)&&(skip=skip+ips.templates.render("chatbox.newcon.chats",{id:$scope.id,title:$scope.title,name:$scope.name,icon:$scope.icon,isOnline:$scope.isOnline,lastMsg:$scope.lastMsg.replace("&#44;",", "),inDay:$scope.inDay,lastMsgTime:$scope.lastMsgTime,unread:$scope.unread>0?$scope.unread:null,isGroup:$scope.isGroup}),$scope.isGroup&&servicesManager.updateConName($scope.id,$scope.name)),$(".convo_"+$scope.id).length>0){var $results_list=$(".convo_"+$scope.id).find(".ipsOnlineStatus_online");if(!$scope.isOnline&&$results_list.is(":visible")){$results_list.hide();}else{if($scope.isOnline&&$results_list.is(":hidden")){$results_list.show();}}}}),skip;},convoTabChange:function(event){var tab_name=$(event.currentTarget).attr("id");return $(event.currentTarget).closest(".convoTabs").find("a").removeClass("isActive"),$(event.currentTarget).addClass("isActive"),$(".cvtabContent").hide(),$("."+tab_name+"_content").show(),false;},closeOldPopups:function(){if(!this.lmn15&&$(window).width()<330*$(".chatBar .inGlobalChat").length-1){if("left"==ips.getSetting("chatbox_bar_pos")){$(".chatBar .inGlobalChat:first").next().find('[data-action="closeChat"]').click();}else{$(".chatBar .inGlobalChat:last").prev().find('[data-action="closeChat"]').click();}}},focusSearchMem:function(){this.lmn4=setInterval(project.bind(this.checkSearching,this),700);},blurSearchMem:function(){clearInterval(this.lmn4);},closeSearch:function(){return this.lmn5=null,$(".closeSearchBtn").hide(),this.lmn10.hide(),this.lmn9.show(),this.scope.find("#searchMem").val(""),false;},checkSearching:function(){var expRecords=this.scope.find("#searchMem").val();if(expRecords.length<3||expRecords==this.lmn5){if(!expRecords){this.closeSearch();}
return;}
this.lmn5=expRecords;$(".closeSearchBtn").show();if(this.lmn11&&this.lmn11.abort){this.lmn11.abort();}
var req=this;return this.lmn11=ips.getAjax()(req.lmn1+"&do=findMember",{data:{input:req.lmn5},type:"post"}).done(function(e){if(e.length){var roster_call="";$.each(e,function(canCreateDiscussions,data){roster_call=roster_call+ips.templates.render("chatbox.newcon.mem",{value:req.lmn5,id:data.id,photo:data.photo,isOnline:data.isOnline,name:data.name,extra:data.extra,conID:data.conID,isBan:data.isBan});});req.lmn10.html(roster_call).show();req.lmn9.hide();}}),false;},openRoom:function(event){var n=this;var i=$(event.currentTarget).attr("data-roomID");var self=$(".chatBar").find(".room_"+i);if(self.length>0){if(self.hasClass("minimize")){self.find('.popupTitle[data-action="toggleChat"]').click();}else{self.fadeOut(80).fadeIn(80).find(".chatInput").focus();}
return;}
var $menuToggle=ips.templates.render("chatbox.blankRoom",{roomID:i});if("left"==ips.getSetting("chatbox_bar_pos")){$(".chatBar").append($menuToggle);}else{$(".chatBar").prepend($menuToggle);}
var container=$(".chatBar").find(".room_"+i);return ips.getAjax()(n.lmn1+"&do=openRoom",{type:"post",data:{room:i}}).done(function(e){if("error"==e.type){ips.ui.alert.show({message:e.message});container.remove();}else{container.replaceWith(e.html);ips.setSetting("chatbox_"+i,e.config);var element=$(".chatBar").find(".room_"+i);element.removeClass("minimize");$(document).trigger("contentChange",[element]);if(element.find(".chatInput")){element.find(".chatInput").focus();}
var msgParts=n.getMyPopups();if(0>msgParts.indexOf("r_"+i)){msgParts.unshift("r_"+i);n.saveMyPopups(msgParts.join("|"));}
n.closeOldPopups();n.resizeBar();}}),false;},chatRowHTML:function(value,point){var self=this;var result="";var th_field="";var patch3c="";var m="chatbox.style."+this.updateStyle(point);var localization=ips.getSetting("chatbox_userFormat");var pix_color="";return $.each(value,function(canCreateDiscussions,comment){if(comment.chatterID>0){th_field=(patch3c=ips.getSetting("baseURL")+"index.php?app=core&module=members&controller=profile&id="+comment.chatterID)+"&do=hovercard";pix_color=localization[comment.chatterGroup].prefix+comment.chatterName+localization[comment.chatterGroup].suffix;result=result+ips.templates.render(m,{id:comment.id,chatterID:comment.chatterID,chatterName:comment.chatterName,chatterKey:comment.chatterKey,chatterNameFormat:pix_color,chatterPhoto:comment.chatterPhoto,chatterUrl:patch3c,memberHovercard:th_field,content:self.parseContent(comment.content),callme:-1!=comment.content.indexOf("@"+ips.getSetting("chatbox_member_name")),isMe:comment.chatterName==ips.getSetting("chatbox_member_name"),inDay:comment.inDay,time:comment.time,canEdit:comment.canEdit,canDelete:comment.canDelete,canReport:comment.chatterName!=ips.getSetting("chatbox_member_name")&&comment.canReport,canManageMSG:comment.canEdit||comment.canDelete});}else{result=result+ips.templates.render("chatbox.style.con.system",{id:comment.id,content:comment.content,inDay:comment.inDay,time:comment.time,canDelete:comment.canDelete});}}),result;},parseContent:function(text){return this.lmn6.use_editor?text:chatbox.parseContent(text,this.lmn6);},enterSubmit:function(ev){if(13===ev.which){return $(ev.currentTarget).closest(".chatboxEditor").submit(),false;}},clickSubmit:function(event){return console.log("aaaa"),$(event.currentTarget).closest("#chatInputArea").find("form").submit(),false;},submitEditor:function(event){event.preventDefault();var c=this;if(c.lmn14){return false;}
var b=$(event.currentTarget).closest(".chatboxConPopup").attr("data-conID");var $sharepreview=$(".convo_"+b);var _formElement=$sharepreview.find(".chatboxEditor");if(this.lmn6.use_editor){var buf=CKEDITOR.instances["chatCON_"+b];var id=buf.getData();}else{id=_formElement.find("textarea").val();id=chatbox.escapeHTML(id);}
return(0!=c.scope.find(".chatboxEditor .ipsAttach_done").length&&!id||0!=c.checkMSG(id))&&0!=c.checkFlood()&&(buf?_formElement.find('button[type="submit"]').prop("disabled",true).text(ips.getString("chatbox_posting")):c.toggleInputForm(b,0),c.lmn14=true,ips.getAjax()(_formElement.attr("action"),{data:_formElement.serialize(),type:"post",bypassRedirect:true}).done(function(e){if("error"==e.type){ips.ui.alert.show({message:e.message});c.lmn14=false;}else{if("deletedCon"==e.type){ips.ui.alert.show({message:e.message});c.closeConversation(e.conID);}else{c.lmn17=true;c.lmn22=b;c.updateChat(true);c.lmn6.lastchat=$.now();$(".chatBar").trigger("resizeBar");}}}).always(function(){c.lmn14=false;c._forceScrollDown=true;c.lmn23["convo_"+b].loadingMore=0;if(buf){ips.ui.editor.getObj($sharepreview.find('[data-role="chatboxFormArea"] [data-ipsEditor]')).reset();_formElement.find('button[type="submit"]').prop("disabled",false).text(ips.getString("chatbox_send"));}else{c.toggleInputForm(b,1);$sharepreview.find(".charCount").hide();if(c.scope.find('#chatInputArea [data-role="deleteFile"]').length>0){c.scope.find('#chatInputArea [data-role="deleteFile"]').each(function(){$(this).click();});}}}),false);},editEditor:function(value){var self=this;var $context=self.scope.find("li#"+value).closest(".chatboxContainer");var scenarioTitle=$context.attr("data-conID");var $innerblock=ips.ui.dialog.create({url:self.lmn1+"&do=editEditor&chatID="+value,size:self.lmn6.use_editor?"normal":"narrow",title:ips.getString("chatbox_edit"),forceReload:true,destructOnClose:true,callback:function(){if(self.lmn6.use_editor){var form=$(".ipsDialog_content .cbEditorEdit").find("form");}else{form=$(".ipsDialog_content .cbCleanTextEdit");form.find("textarea").on("keypress",function(event){if(13===event.which){return form.submit(),false;}});}
form.on("submit",function(event){if(event.preventDefault(),self.lmn6.use_editor){var editor=CKEDITOR.instances["chatCON_"+scenarioTitle+"_"+value];editor.updateElement();var id=editor.getData();}else{id=$(this).find("textarea").val();id=chatbox.escapeHTML(id);}
if((0==$(event.currentTarget).find(".ipsAttach_done").length||id)&&0==self.checkMSG(id)){return false;}
var tosend_formatted=$(event.currentTarget).serializeArray();return tosend_formatted.push({name:"newMsg",value:id}),ips.getAjax()($(event.currentTarget).attr("action"),{data:tosend_formatted,type:"post",bypassRedirect:true}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{ips.ui.flashMsg.show(ips.getString("chatbox_edited"));$context.find("#chatRow_"+value+" .chatbox_msg").html(self.parseContent(response.content));$(document).trigger("contentChange",[$context]);}}).always(function(canCreateDiscussions){$innerblock.hide();}),false;});}});return $innerblock.show(),false;},checkFlood:function(){if(this.lmn6.flood>0&&1!=this.lmn6.canManage&&!this.lmn6.canBypassFlood){var first_cell_percentage=($.now()-this.lmn6.lastchat)/ 1E3;if(first_cell_percentage<this.lmn6.flood){return ips.ui.alert.show({message:ips.getString("chatbox_error_flood",{time:(this.lmn6.flood-first_cell_percentage).toFixed(2)})}),0;}}
return 1;},checkMSG:function(headers){headers=headers.trim();var i=this.lmn6.length;return headers.length<=0?(ips.ui.alert.show({message:ips.getString("chatbox_error_empty")}),0):i>0&&headers.length>i?(ips.ui.alert.show({message:ips.pluralize(ips.getString("chatbox_error_maxlength"),i)}),0):1;},conOptions:function(event,e){switch((event=e?e.originalEvent:event).preventDefault(),$(event.target).attr("data-action")){case"toggleSound":this.toggleSound(event,e);break;case"closeAllTabs":this.closeAllTabs(event,e);break;case"miniAllTabs":this.miniAllTabs(event,e);break;case"silentMode":this.silentMode(event,e);break;case"delCon":this.delCon(event,e);break;case"configGroup":this.configGroup(event,e);break;case"inviteGroup":this.inviteGroup(event,e);break;case"renameGroup":this.renameGroup(event,e);break;case"leaveGroup":this.leaveGroup(event,e);break;case"usersInGroup":this.usersInGroup(event,e);break;case"changeSkin":this.changeSkin(event,e);break;case"changeStyle":this.changeStyle(event,e);}},toggleSound:function(e,event){event.originalEvent.preventDefault();var primaryField=$(e.target).closest(".chatboxContainer").attr("data-conID");var a=ips.utils.cookie.get("chatbox_con_nosound_"+primaryField);$(e.target).find(".fa").replaceWith($("<i/>").addClass("fa").addClass(1!=a?"fa-volume-off":"fa-volume-up").removeClass(1!=a?"fa-volume-up":"fa-volume-off"));ips.utils.cookie.set("chatbox_con_nosound_"+primaryField,1==a?0:1);},closeAllTabs:function(controller,e){return e.originalEvent.preventDefault(),$(".chatBar").find(".inGlobalChat").each(function(canCreateDiscussions){$(this).find('.miniTitle [data-action="closeChat"]').click();}),false;},miniAllTabs:function(params,event){return event.originalEvent.preventDefault(),$(".chatBar").find(".inGlobalChat").each(function(canCreateDiscussions){if(!$(this).hasClass("minimize")){$(this).find('.mainTitle [data-action="toggleChat"]').click();}}),false;},silentMode:function(params,event){event.originalEvent.preventDefault();var o="";var a=ips.utils.cookie.get("chatbox_is_silent");return $(params.target).find(".cbToggleIcon").addClass(1==a?"fa-toggle-off":"fa-toggle-on").removeClass(1==a?"fa-toggle-on":"fa-toggle-off"),ips.utils.cookie.set("chatbox_is_silent",1==a?0:1),1==ips.utils.cookie.get("chatbox_is_silent")?(o=ips.getString("chatbox_on_silent"),$('[data-action="toggleSound"]').closest("li").hide()):(o=ips.getString("chatbox_off_silent"),$('[data-action="toggleSound"]').closest("li").show()),ips.ui.flashMsg.show(o),false;},delCon:function(params,event){event.originalEvent.preventDefault();var main=this;var conversation=$(params.target).closest(".chatboxContainer").attr("data-conID");return ips.ui.alert.show({type:"confirm",message:ips.getString("chatbox_del_con_cfr"),icon:"warn",buttons:{ok:ips.getString("chatbox_confirm_yes"),cancel:ips.getString("chatbox_confirm_cancel")},callbacks:{ok:function(){ips.getAjax()(main.lmn1+"&do=delCon",{type:"post",data:{conID:conversation}}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{main.closeConversation(conversation);main.resizeBar();}});}}}),false;},changeSkin:function(args,evt){evt.originalEvent.preventDefault();var skin=$(args.target).data("skin");var i=$(args.target).closest(".chatboxContainer").attr("data-conID");return $(args.target).closest(".chatboxSkins").find("li").removeClass("skinSelected"),$(args.target).addClass("skinSelected"),$(args.target).closest(".bimChatbox").removeClass(function(canCreateDiscussions,strRect){return(strRect.match(/(^|\s)skin_\S+/g)||[]).join(" ");}),$(args.target).closest(".bimChatbox").addClass("skin_"+skin),i>0?ips.utils.cookie.set("chatbox_con_skin_"+i,skin):ips.utils.cookie.set("chatbox_maincon_skin",skin),false;},changeStyle:function(event,options){options.originalEvent.preventDefault();var o=this;var w=$(event.target).closest(".chatboxContainer").attr("data-conID");return $(event.target).one("change",function(){var value=this.value;return ips.utils.cookie.set("chatbox_con_style_"+w,value),$(".convo_"+w).find("#chatContent").empty(),o.lmn23["convo_"+w].lastID=0,o.lmn19=w,o.lmn22=w,o.updateChat(true),false;}),false;},updateStyle:function(source){return 1==this.lmn6.allow_select_skins&&ips.utils.cookie.get("chatbox_con_style_"+source)?ips.utils.cookie.get("chatbox_con_style_"+source):this.lmn6.style?this.lmn6.style:"standard";},mention:function(msg){return msg.preventDefault(),chatbox.mention(msg,this.lmn6.use_editor),false;},resizeBar:function(){if($(".chatBar").find(".convoList").length>0){if(ips.utils.responsive.currentIs("tablet")||ips.utils.responsive.currentIs("phone")){$(".chatBar").addClass("chatBoxMessenger");this.lmn15=true;var readersLength=$(".chatBar").find(".openFromBar").length;if(0==readersLength){$(".chatBar").find(".convoList").show();}else{if(1==readersLength){$(".chatBar").find(".convoList").hide();}else{if(readersLength>1){$(".chatBar").find(".openFromBar").each(function(canCreateDiscussions){$(this).find('[data-action="closeChat"]').click();});}}}}else{$(".chatBar").find(".convoList").show();$(".chatBar").removeClass("chatBoxMessenger");this.lmn15=false;}}
var height=1==ips.getSetting("chatbox_bar_full")&&ips.utils.responsive.currentIs("phone")?$(window).height():ips.getSetting("chatbox_popup_height");return $(".mbBottomPlayer").length&&$(".mbBottomPlayer").is(":visible")&&(height=height-60),$(".chatBar .inGlobalChat").each(function(){if(!$(this).hasClass("minimize")){var _h=height<=$(window).height()?height:$(window).height();var element=$(this).find(".cbScroll");if(1!=ips.getSetting("chatbox_force_scroll_down")){var a=element.scrollTop()+element.innerHeight()-element.prop("scrollHeight")>=-30;}else{a=true;}
if(_h<=$(this).height()){element.height(element.height()-($(this).height()-_h));}else{element.height(height-($(this).height()-element.height()));}
if($(this).height()>$(window).height()){element.height(element.height()-($(this).height()-$(window).height()));}
if(a&&element.hasClass("asc")){element.scrollTop(element.prop("scrollHeight"));}}}),$(".cbLastMSG").width($(".convoList").width()-63),false;},toggleChat:function(e){e.preventDefault();var element=$(e.currentTarget).closest(".bimChatbox");var j=element.hasClass("convoTab")?element.find(".chatboxContainer").attr("data-conID"):0;var group=this.getMiniTabs();if(element.hasClass("minimize")){if($(e.currentTarget).find(".unknown").length>0){return element.find('[data-action="closeChat"]').click(),false;}
element.removeClass("minimize");if(element.hasClass("convoTab")){this.updateFocusTabs(j);this.lmn22=j;this.updateChat(true);}
this.resizeBar();if(this.lmn15){$(".chatBar").css({width:"100%"});}
group.splice($.inArray("c_"+j,group),1);}else{element.addClass("minimize");if(this.lmn15){$(".chatBar").css({width:"auto"});}
if(0>group.indexOf("c_"+j)){group.unshift("c_"+j);}}
return this.saveMiniTabs(group.join("|")),false;},closeChat:function(event){var selected_genes=this.getMyPopups();var args=this.getMiniTabs();var fieldOrGroup=$(event.currentTarget).closest(".chatboxContainer");if(fieldOrGroup.closest(".bimChatbox").hasClass("minimize"),fieldOrGroup.hasClass("chatboxConPopup")){var id=fieldOrGroup.attr("data-conID");var key="c_"+id;delete this.lmn23["convo_"+id];}else{id=fieldOrGroup.attr("data-roomID");key="r_"+id;}
return selected_genes.splice($.inArray(key,selected_genes),1),this.saveMyPopups(selected_genes.join("|")),args.splice($.inArray(key,args),1),this.saveMiniTabs(args.join("|")),$(event.currentTarget).closest(".bimChatbox").remove(),this.lmn15&&$(".convoList").hasClass("minimize")?$(".convoList").find('.miniTitle[data-action="toggleChat"]').click():this.resizeBar(),0>$.inArray(id,this.lmn26)&&this.lmn26.push(id),false;},closeConversation:function(conversation){$(".convo_"+conversation).find('[data-action="closeChat"]').click();$(".convoTab_chats_content").find('[data-conid="'+conversation+'"]').remove();},goDown:function(id){var $el=$(".convo_"+id).find("#chatContentIframe");$(".convo_"+id).find("#chatContent");var o=0!=this.lmn23["convo_"+id].loadingMore;if(!o){$el.scrollTop($el.prop("scrollHeight"));}
if(!this._blankImage){$el.find("img").imagesLoaded(function(canCreateDiscussions){if(!o){$el.scrollTop($el.prop("scrollHeight"));}});}}});}(jQuery,_);;
'use strict';!function($,_,i){ips.controller.register("bim.chatbox.media",{lmn1:null,lmn2:null,lmn3:null,lmn4:"",lmn5:0,initialize:function(){if(this.scope.find("#chatInputArea textarea").length>0){this.on("click",'[data-action="emoji"]',this.emoji);this.on("click",'[data-action="bimGiphy"]',this.bimGiphy);this.on("focus","#chatInputArea textarea",this.focusChatInput);this.on("blur","#chatInputArea textarea",this.blurChatInput);this.on("input","#chatInputArea textarea",this.autoGrowTextarea);if(!$("body").find("#chatboxEmoji_menu").length){$("body").append(ips.templates.render(1==ips.getSetting("chatbox_no_emoji")?"chatbox.emoticons":"core.editor.emoticons",{id:"chatboxEmoji",editor:"chatboxEditor"}));}
if(!ips.utils.db.get("chatboxEmoji",ips.getSetting("baseURL")+"-"+ips.getSetting("emoji_cache"))){chatbox.emoji.getEmoji();}}else{this.on("click",".ipsAttachLink_image",this.lightboxIMG);}
this.on("click",'[data-action="zoomImage"]',this.zoomImage);this.on("click",'[data-action="playVideoInPopup"]',this.playVideoInPopup);this.on("click",'[data-action="playVideoInIframe"]',this.playVideoInIframe);this.on("fileAdded",this.fileAdded);this.on("fileDeleted",this.deletedFile);if("roomChat"==this.scope.closest(".bimChatbox").attr("id")){this.lmn1=this.scope.attr("data-roomID");this.lmn2=ips.getSetting("chatbox_"+this.lmn1);}else{this.lmn1=this.scope.attr("data-conID");this.lmn2=ips.getSetting("chatbox_conversations");}
var node=this.scope.find("#chatInputArea textarea");node.val("");if(!this.lmn2.autogrow){node.css("white-space","pre");}},lightboxIMG:function(event){if(void 0===$(event.currentTarget).data("ipslightbox")){return $(event.currentTarget).attr("data-ipslightbox",""),$(document).trigger("contentChange",[$(event.currentTarget)]),$(event.currentTarget).click(),false;}},autoGrowTextarea:function(event){var $this=$(event.currentTarget);var z=this.lmn2.length;if(z>0){var y=$this.val().length;var $wrapper=this.scope.find(".charCount");$wrapper.text(y+"/"+z);if(0==y){$wrapper.hide();}else{$wrapper.show();if(y<=z){if($wrapper.hasClass("isOver")){$wrapper.removeClass("isOver");}}else{if(!$wrapper.hasClass("isOver")){$wrapper.addClass("isOver");}}}}
if(this.lmn2.autogrow){var $photowrapper=$this.closest(".bimChatbox");var m=$photowrapper.height();var elem=$this.closest("#chatInputArea");var c=$this.height();var dontAnimate=false;if($this.css("height","auto").css("height",$this[0].scrollHeight+"px"),elem.hasClass("expanded")?0==$this.val().length&&0==$this.find(".ipsAttach").length&&(elem.removeClass("expanded"),dontAnimate=true):c<$this.height()&&(elem.addClass("expanded"),dontAnimate=true),dontAnimate||c==$this.height()||(dontAnimate=true),dontAnimate){if(elem.hasClass("sort_asc")){var $el=$photowrapper.find("#chatContentIframe");if($el.scrollTop()+$el.innerHeight()-$el.prop("scrollHeight")>=-30){var p=true;}}
if($this.closest(".inGlobalChat").length>0){$(".chatBar").trigger("resizeBar");}else{var cssChanges=$photowrapper.find(".cbScroll");var n=$photowrapper.height();if(n>m){cssChanges.height(cssChanges.height()-(n-m));}else{if($photowrapper.height()<m){cssChanges.height(cssChanges.height()+(m-n));}}}
if(p){$el.scrollTop($el.prop("scrollHeight"));}}}},emoji:function(event){if($("#chatboxEmoji_menu").find(".ipsEmoticons_contentLoading").length>0){$(document).trigger("contentChange",[$("#chatboxEmoji_menu")]);}
$("#chatboxEmoji").attr("id","");var toShow=$(event.currentTarget);toShow.attr("id","chatboxEmoji");toShow.attr("data-ipsmenu","");toShow.attr("data-ipsmenu-closeonclick","false");$("#chatboxEmoji_menu").attr("data-btnID",toShow.attr("data-btnID"));},zoomImage:function(ev){var MY_NUMBER="roomChat"==this.scope.closest(".bimChatbox").attr("id")?"room":"con";var salesTeam=$(ev.currentTarget).closest(".chat_row").attr("id");var data=$(ev.currentTarget).attr("href");return ips.getAjax()(ips.getSetting("baseURL")+"index.php?app=chatbox&module=chatbox&controller=chatbox&do=zoomImage",{data:{from:MY_NUMBER,chatID:salesTeam,thumb:data},type:"post"}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{$(ev.currentTarget).removeAttr("data-action");$(ev.currentTarget).attr("data-ipslightbox","");$(ev.currentTarget).attr("href",response.image);$(ev.currentTarget).click();}}),false;},playVideoInPopup:function(event){var layerG=$(event.currentTarget).closest(".chatboxVideoContainer");var doc_id=$(event.currentTarget).closest(".chat_row").attr("id");return $("body").append(ips.templates.render("chatbox.videoPopup",{chatID:doc_id,play:layerG.attr("data-play"),html5:layerG.attr("data-html5")})),ips.ui.dialog.create({fixed:false,size:"medium",forceReload:true,content:".videopopup_"+doc_id}).show(),this.stopPlayingVideos(),false;},playVideoInIframe:function(event){this.stopPlayingVideos();var $Qv=$(event.currentTarget).closest(".chatboxVideoContainer");return $Qv.find(".chatboxVideo").html(ips.templates.render("chatbox.videoIframe",{play:$Qv.attr("data-play")})),false;},stopPlayingVideos:function(){this.scope.find(".chatboxPlayer").each(function(){if("VIDEO"==$(this).prop("nodeName")){$(this).get(0).pause();}else{var element=$(this).closest(".chatboxVideoContainer");element.replaceWith(ips.templates.render("chatbox.parseVideo",{source:element.attr("data-source"),url:element.attr("data-url"),play:element.attr("data-play"),id:element.attr("data-id"),img:element.attr("data-img"),html5:element.attr("data-html5"),blankImage:null}));}});},focusChatInput:function(){this.lmn3=setInterval(_.bind(this.checkTyping,this),700);},blurChatInput:function(){clearInterval(this.lmn3);},checkTyping:function(){var selectedAirline=this.scope.find(".chatInput").val();if(selectedAirline!=this.lmn4){if(0!=selectedAirline.indexOf("/giphy ")){var e=this.scope.find(".chatboxMedia");if(e.is(":visible")){e.empty().hide();}
return;}
this.lmn4=selectedAirline;var executableCode=selectedAirline.split(" ")[0].toLowerCase();if("asc"==this.lmn2.sort){this.scope.find(".chatboxMedia").css({bottom:this.scope.find("#chatInputArea").outerHeight()+30});}else{this.scope.find(".chatboxMedia").css({top:this.scope.height()-this.scope.find("#chatContentIframe").height()});}
this.cmdMedia(executableCode);}},cmdMedia:function(code){var i=this;if("/giphy"==code){if("cmd"!=i.lmn2.giphy&&"both"!=i.lmn2.giphy){return false;}
if(this._ajax&&this._ajax.abort){this._ajax.abort();}
var a=i.scope.find(".chatboxMedia");return a.is(":visible")||a.show(),a.empty().addClass("ipsLoading"),this._ajax=ips.getAjax()(ips.getSetting("baseURL")+"index.php?app=core&module=system&controller=plugins&do=bimGiphy&editorId=giphyCMD",{data:{q:i.lmn4.substring(code.length+1)},type:"post"}).done(function(e){a.html(e);$(document).trigger("contentChange",[i.scope.find(".chatboxMedia")]);}).always(function(){a.removeClass("ipsLoading");}),false;}},bimGiphy:function(){if("roomChat"==this.scope.closest(".bimChatbox").attr("id")){var r="room";}else{r="convo";}
var requestOrUrl=ips.getSetting("baseURL")+"index.php?app=core&module=system&controller=plugins&do=bimGiphy&editorId=chatbox_"+r+"_"+this.lmn1;var result=ips.utils.db.get("bimgiphy_gif","recent");var data=null;return _.isArray(result)&&(data=JSON.stringify(result)),ips.ui.dialog.create({fixed:false,size:"medium",title:ips.getString("bim_giphy"),url:requestOrUrl,forceReload:true,ajax:{type:"post",data:{recent:data}}}).show(),false;},fileAdded:function(file,filepath){if(this.lmn2.autogrow&&$(file.target).closest("#chatInputArea").length>0){if(0==this.lmn5){this.lmn5=this.scope.closest(".bimChatbox").height()-this.scope.find(".ipsAttachment_fileList").height();}
$(file.target).closest("#chatInputArea").addClass("expanded");this.scope.find(".chatInput").focus();this.resizeBox();}},deletedFile:function(e,i){if(0===i.count&&this.lmn2.autogrow&&$(e.target).closest("#chatInputArea").length>0){$(e.target).closest("#chatInputArea").removeClass("expanded");this.resizeBox();}},resizeBox:function(){if(this.scope.closest(".inGlobalChat").length>0){$(".chatBar").trigger("resizeBar");}else{var cssChanges=this.scope.closest(".bimChatbox").find(".cbScroll");var i=this.scope.closest(".bimChatbox").height();if(i>this.lmn5){cssChanges.height(cssChanges.height()-(i-this.lmn5));}else{if(this.scope.closest(".bimChatbox").height()<this.lmn5){cssChanges.height(cssChanges.height()+(this.lmn5-i));}}}}});}(jQuery,_);;
'use strict';!function($,ds,n){ips.controller.register("bim.chatbox.room",{lmn1:null,lmn2:null,lmn3:null,lmn4:null,lmn5:null,lmn6:null,lmn7:null,lmn8:12e4,lmn9:true,lmn10:false,lmn11:null,lmn12:null,lmn13:null,lmn14:null,lmn15:null,_lastMSG:0,_joined:0,lmn9:true,lmn10:false,lmn18:true,lmn19:true,lmn20:false,lmn21:false,lmn22:false,lmn23:false,lmn24:false,lmn25:false,lmn26:false,lmn27:false,lmn28:0,lmn29:null,lmn30:false,lmn31:false,lmn32:null,lmn33:0,initialize:function(){this.configRoom();this.on("menuItemSelected","#listRooms",this.listRooms);this.on("click",'[data-action="toggleChat"]',this.toggleChat);this.on(window,"resize",this.resizeWindow);if(!(this.scope.closest(".bimChatbox").hasClass("inGlobalChat")||0!=$(".chatBoxFull").length)){this.scope.closest(".bimChatbox").resizable({handles:"s",alsoResize:"#chatContentIframe, #userListIframe",stop:function(isSilent,reason){$(this).css("width","");}});}
if(0==this.scope.find(".chatboxIndentifyGuest").length&&0==this.scope.find(".chatboxRulesWrapper").length){this.on("click",'.ipsButton[data-action="addToBlockedList"]',this.click_addToBlockedList);this.on("click",'[data-action="connect"]',this.connect);this.on("click",'[data-action="chattersList"]',this.chattersList);this.on("menuItemSelected","#roomOptions"+this.lmn2,this.roomOptions);this.on("menuItemSelected",".msgAction",this.msgAction);this.on("click",'[data-action="mention"]',this.mention);this.on("click",'[data-action="donate"]',this.donate);this.on("click",'[data-action="refresh"]',this.refresh);this.on("submit",".chatboxEditor",this.submitEditor);if(!this.lmn1.use_editor){this.on("click",'#chatInputArea [data-action="sendMSG"]',this.clickSubmit);this.on("keypress","#chatInputArea textarea",this.enterSubmit);}
if(this.lmn1.autoload){this.scope.find("#chatContentIframe").on("scroll",ds.bind(this.autoLoad,this));}else{this.on("click",'[data-action="loadMore"]',this.loadMore);}
this.startRoom();}
if(this.scope.find(".chatboxIndentifyGuest").length>0){this.on("click",'[data-action="saveGuestName"]',this.saveGuestName);this.on("onsubmit",'[data-action="guestForm"]',this.saveGuestName);if(!(1!=this.lmn1.auto_guest||this.scope.closest(".bimChatbox").hasClass("minimize"))){this.scope.find(".guestName").val("Guest"+$.now());this.scope.find('[data-action="saveGuestName"]').click();}}
if(this.scope.find(".chatboxRulesWrapper").length>0){this.on("submit",".chatboxRulesWrapper form",this.acceptRules);}
var $img=this.scope.closest(".chatboxWidget");if($img.length>0){var maxWidth=$img.closest(".cWidgetContainer").width();$img.css({width:"100%","max-width":maxWidth+"px !important"}).show();}},configRoom:function(){if(this.lmn2=this.scope.attr("data-roomID"),this.lmn1=ips.getSetting("chatbox_"+this.lmn2),this.updateStyle(),this.lmn3=ips.getSetting("baseURL")+"index.php?app=chatbox&module=chatbox&controller=room&id="+this.lmn2,this.lmn11=ips.getSetting("lazyLoadEnabled")?ips.getSetting("blankImg"):null,this.lmn4file=this.lmn1.soundfile?this.lmn1.soundfile:ips.getSetting("baseURL")+"applications/core/interface/sounds/notification.mp3",this.lmn28=this.scope.find("#chatContentIframe").height(),$(".chatBoxFull").length){var zeroSizeMax=$(".bimChatbox").height();var pixelSizeTargetMax=$("#chatContentIframe").height();var chheight=zeroSizeMax-pixelSizeTargetMax;$("#chatContentIframe").height($(window).innerHeight()-chheight);$("#userListIframe").height($(window).innerHeight()-chheight);$(".chatBoxFull").show();$(window).resize(function(){$("#chatContentIframe").height($(window).innerHeight()-chheight);$("#userListIframe").height($(window).innerHeight()-chheight);$(".chatBoxFull").show();});this.lmn28=$("#chatContentIframe").height();document.title=this.lmn1.roomname;}
if(this.scope.closest(".bimChatbox").hasClass("inGlobalChat")){this.lmn31=!!ips.utils.cookie.get("chatbox_is_silent");}
this.fixTheSize();},startRoom:function(){var sound=this;ips.loader.get(["core/interface/howler/howler.core.min.js"]).then(function(){sound.lmn4=new Howl({src:sound.lmn4file,autoplay:false});});if($(".convoList").length<=0){chatbox.initTimeago();}
if(this.lmn1.musicbox){this.jPlayer();}
this.autoMessages();this.ping(true);},fixTheSize:function(){if(this.scope.closest(".chatBar").length>0){var e=true;if(ips.getSetting("chatbox_bar_mini")&&($.each(ips.getSetting("chatbox_bar_mini").split(","),function(canCreateDiscussions,p_Interval){if(ips.utils.responsive.currentIs(p_Interval.toLowerCase())){return e=false,false;}}),!e)){return;}}else{if(this.scope.closest(".chatboxWidget").length>0){e=true;var layerG=this.scope.closest(".chatboxWidget");if(layerG.attr("data-automini")&&($.each(layerG.attr("data-automini").split(","),function(canCreateDiscussions,p_Interval){if(ips.utils.responsive.currentIs(p_Interval.toLowerCase())){return e=false,false;}}),!e)){return;}}}
this.toggleOn();},autoMessages:function(){var that=this.lmn1.automsg;if(!that){return false;}
var state=that.bot;var self=this;$.each(that.messages,function(canCreateDiscussions,result){state.content=result.msg;state.showAgoTime=Math.floor(Date.now()/ 1E3);var data=[state];var previewPane=self.scope.find("#chatContentIframe");var content=self.scope.find("#chatContent");setInterval(function(){if("asc"==self.lmn1.sort){if(previewPane.scrollTop()+previewPane.innerHeight()-previewPane.prop("scrollHeight")>=-30){var indent=1;}
content.append(self.chatRowHTML(data));$(document).trigger("contentChange",[content]);if(1==indent||self.lmn25){self.goDown();}}else{content.prepend(self.chatRowHTML(data));$(document).trigger("contentChange",[content]);}
if($(".timeago:not(.loadedAgo)").timeago(),self.lmn1.limit>0&&!self.lmn24){var n=content.children().length-self.lmn1.limit;if(n>0){content.find("li:nth"+("asc"==self.lmn1.sort?"":"-last")+"-child(-n+"+n+")").remove();}}
if(!(self.lmn31||1==ips.utils.cookie.get("chatbox_nosound_"+self.lmn2)||self.lmn19||self.lmn23)){self.lmn4.play();}},1E3*result.time);});},ping:function(fullReload){var self=this;if(self.scope.closest(".bimChatbox").hasClass("minimize")&&!self.lmn1.alwaysON||this.lmn26&&!this.lmn9){return false;}
if(true==fullReload){clearTimeout(self.lmn7);}
self.doPing(function(){self.lmn7=setTimeout(function(){self.ping(true);},self.lmn8);});},doPing:function(callback){var self=this;return 0==$(".room_"+self.lmn2).length?(self.stopUpdate(),false):!self.lmn10&&void(self.lmn10=true,ips.getAjax()(self.lmn3+"&do=ping",{type:"post",dataType:"json"}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{if("errorGuestName"==response.type){self.stopUpdate();location.reload();}else{if(self.lmn9){self.updateChat(true);self.lmn9=false;}
self.lmn10=false;if("function"==typeof callback){callback();}}}
if(1!=self._joined){self._joined=1;self.lmn3=self.lmn3+"&joined="+self._joined;}}).fail(function(){if(1==ips.getSetting("chatbox_no_disconnect")){self.lmn10=false;if("function"==typeof callback){callback();}}else{self.disconnect();}}));},refresh:function(){return this.lmn19||this.updateChat(true),false;},updateChat:function(callback){var e=this;if(e.scope.closest(".bimChatbox").hasClass("minimize")&&!e.lmn1.alwaysON||e.lmn26&&!e.lmn19){return false;}
if(true==callback){clearTimeout(e.lmn6);}
var X=e.lmn1.interval>=5E3?e.lmn1.interval:5E3;e.doUpdateChat(function(){e.lmn6=setTimeout(function(){e.updateChat(true);},X);});},doUpdateChat:function(callback){var self=this;if(self.lmn19&&chatbox.initCleanEditor(self.scope),0==$(".room_"+self.lmn2).length){return self.stopUpdate(),false;}
if(self.lmn20){return false;}
if(self.lmn20=true,"asc"==self.lmn1.sort){var a=self._lastMSG>0?self._lastMSG:self.scope.find(".chat_row").last().attr("id");}else{a=self._lastMSG>0?self._lastMSG:self.scope.find(".chat_row").first().attr("id");}
ips.getAjax()(self.lmn3+"&do=getMSG",{dataType:"json",type:"post",data:{lastID:a||0,firstLoad:self.lmn19?1:0,loadMoreMode:0,isReconnect:self.lmn27?1:0}}).done(function(data){if("error"==data.type){ips.ui.alert.show({message:data.message});}else{if("isBlocked"==data.type){self.kick();return;}else{if(self.lmn19&&self.scope.find("#chatboxRoom .ipsLoading").removeClass("ipsLoading"),self.lmn27&&self.connected(),self.scope.find(".colUserList").length>0){if(data.chatters){var o=Object.keys(data.chatters);if(self.lmn1.theLastUser!=o[1]||self.lmn19){self.lmn1.theLastUser=o[1];var list=self.scope.find("#userList");list.html(self.chattersListFormat(data.chatters));$(document).trigger("contentChange",[list]);}}else{self.lmn1.theLastUser=0;}}
if(data.content){var elem=self.scope.find("#chatContentIframe");var content=self.scope.find("#chatContent");if("asc"==self.lmn1.sort){if(elem.scrollTop()+elem.innerHeight()-elem.prop("scrollHeight")>=-30){var indent=1;}
content.append(self.chatRowHTML(data.content));if(self.lmn19&&!self.lmn1.autoload&&data.content.length==self.lmn1.limit){content.prepend(ips.templates.render("chatbox.loadMoreBtn"));}
$(document).trigger("contentChange",[elem]);if(1==indent||self.lmn25){self.goDown();}}else{content.prepend(self.chatRowHTML(data.content));if(self.lmn19&&!self.lmn1.autoload&&data.content.length==self.lmn1.limit){content.append(ips.templates.render("chatbox.loadMoreBtn"));}
$(document).trigger("contentChange",[elem]);}
if($(".timeago:not(.loadedAgo)").timeago(),data.updateAnn){var searchContactPanel=self.scope.find(".cbAnn");if("remove"==data.updateAnn){if(!self.lmn19){searchContactPanel.hide();}}else{searchContactPanel.show();var id=self.scope.closest(".bimChatbox").hasClass("inGlobalChat")||1!=data.updateAnn[2]?0:1;searchContactPanel.find(".annTitle").html(data.updateAnn[id]);}}
if(!(self.lmn31||1==ips.utils.cookie.get("chatbox_nosound_"+self.lmn2)||self.lmn19||self.lmn23)){self.lmn4.play();}
content.find("img").imagesLoaded(function(canCreateDiscussions){self.lmn19=false;});}
self._lastMSG=data.lastID;if(data.update){$.each(data.update,function(sCompId,text){if(text){self.scope.find("#"+sCompId+" .chatbox_msg").html(self.parseContent(text));}else{self.scope.find("#"+sCompId).remove();}});}
if(!(1!=self.lmn1.musicbox)){if(data.song){if(!self.lmn19){if(data.song.id!=self.lmn12){self.lmn1.song=data.song;}
self.playSong();}}else{self.hideMusicPlayer();}}}}
self.lmn20=false;if("function"==typeof callback){callback();}}).fail(function(){if(1==ips.getSetting("chatbox_no_disconnect")){self.lmn20=false;if("function"==typeof callback){callback();}}else{self.disconnect();}}).always(function(canCreateDiscussions){self.lmn25=false;self.lmn23=false;});},msgAction:function(d,e){(d=e?e.originalEvent:d).preventDefault();var action=$(d.target).attr("data-action");var element=$(d.target).attr("data-chatID");if(action){switch(action){case"edit":this.editEditor(element);break;case"delete":this.deleteMSG(element);break;case"report":this.reportMSG(element);break;case"addToBlockedList":var highkey=$(d.target).attr("data-key");var personId=$(d.target).attr("data-ip");var c=$(d.target).attr("data-name");this.addToBlockedList(element,highkey,c,personId);}}
return false;},deleteMSG:function(selector){var e=this;return ips.ui.alert.show({type:"confirm",message:ips.getString("chatbox_confirmDelete"),icon:"warn",buttons:{ok:ips.getString("chatbox_confirm_yes"),cancel:ips.getString("chatbox_confirm_cancel")},callbacks:{ok:function(){ips.getAjax()(e.lmn3+"&do=deleteMSG",{type:"post",data:{chatID:selector}}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{ips.ui.flashMsg.show(ips.getString("chatbox_deleted"));e.scope.find("li#"+selector).remove();}});}}}),false;},reportMSG:function(module){var $innerblock=ips.ui.dialog.create({url:ips.getSetting("baseURL")+"index.php?app=chatbox&module=chatbox&controller=msg&do=report&id="+module,size:"medium",title:ips.getString("chatbox_report"),forceReload:false,destructOnClose:true,callback:function(e){$(e).find("form").on("submit",function(event){var instanceName;for(instanceName in event.preventDefault(),CKEDITOR.instances){CKEDITOR.instances[instanceName].updateElement();}
var o=$(event.currentTarget);return ips.getAjax()(o.attr("action"),{data:o.serialize(),type:"post",bypassRedirect:true}).done(function(canCreateDiscussions){ips.ui.flashMsg.show(ips.getString("chatbox_sent_report"));}).always(function(canCreateDiscussions){$innerblock.hide();}),false;});}});return $innerblock.show(),false;},chatRowHTML:function(e){var self=this;var value="";var th_field="";var patch3c="";var x="chatbox.style."+this.lmn1.style;var localization=ips.getSetting("chatbox_userFormat");var commentText="";return $.each(e,function(canCreateDiscussions,comment){var l=comment.id>0?comment.id:0;if(!(l>0)||!(self.scope.find("#chatRow_"+l).length>0)){if(-1!=comment.chatterID){var h=!!self.lmn1.canManage&&comment.chatterID!=ips.getSetting("memberID");if(comment.chatterID>0&&(th_field=(patch3c=ips.getSetting("baseURL")+"index.php?app=core&module=members&controller=profile&id="+comment.chatterID)+"&do=hovercard"),comment.donation&&comment.donation.amount){var key=parseFloat(comment.donation.amount.replace(",",".").replace(" ",""));}
var id=key?self.superChatBackground(key):null;var idHTML=id?chatbox.invertColor(id,true):null;var forel=id?chatbox.invertColor(id):null;commentText=comment.chatterName;if(void 0!==localization[comment.chatterGroup]&&null!==localization[comment.chatterGroup]){commentText=localization[comment.chatterGroup].prefix+comment.chatterName+localization[comment.chatterGroup].suffix;}
value=value+ips.templates.render(id?"chatbox.style.superchat":x,{id:l,chatterID:comment.chatterID,chatterName:comment.chatterName,chatterKey:comment.chatterKey,chatterNameFormat:commentText,chatterPhoto:comment.chatterID>0?comment.chatterPhoto:"https://www.gravatar.com/avatar/"+comment.chatterPhoto+"?s=32&d=wavatar&r=PG",chatterUrl:patch3c,chatterIP:comment.chatterIP,memberHovercard:th_field,content:self.parseContent(comment.content),callme:-1!=comment.content.indexOf("@"+ips.getSetting("chatbox_member_name")),isMe:comment.chatterName==ips.getSetting("chatbox_member_name"),inDay:comment.inDay,time:comment.time,mainBg:id,subBg:"FFFFFF"==idHTML?"rgba(255, 255, 255, 0.075)":"rgba(82.7, 82.7, 82.7, 0.04)",mainTxt:idHTML,subTxt:forel,money:comment.donation?comment.donation.money:0,canEdit:comment.canEdit,canDelete:comment.canDelete,canReport:comment.chatterName!=ips.getSetting("chatbox_member_name")&&comment.canReport,canBeBlocked:h,canManageMSG:comment.canEdit||comment.canDelete||comment.canReport||h});}else{if(self.lmn1.bot_id>0){commentText=self.lmn1.bot_name;if(void 0!==localization[self.lmn1.bot_group]&&null!==iconfFormat[self.lmn1.bot_group]){commentText=localization[self.lmn1.bot_group].prefix+self.lmn1.bot_name+localization[self.lmn1.bot_group].suffix;}
value=value+ips.templates.render(x,{id:l,chatterID:self.lmn1.bot_id,chatterName:self.lmn1.bot_name,chatterNameFormat:commentText,chatterPhoto:self.lmn1.bot_photo,chatterUrl:self.lmn1.bot_url,memberHovercard:ips.getSetting("baseURL")+"index.php?app=core&module=members&controller=profile&id="+self.lmn1.bot_id+"&do=hovercard",content:"<i class='fa fa-angle-double-right'></i> "+comment.content,callme:-1!=comment.content.indexOf("@"+ips.getSetting("chatbox_member_name")),isMe:self.lmn1.bot_name==ips.getSetting("chatbox_member_name"),inDay:comment.inDay,time:comment.time,canDelete:comment.canDelete});}else{value=value+ips.templates.render("chatbox.style.room.system",{id:comment.id,content:comment.content,inDay:comment.inDay,time:comment.time,canDelete:comment.canDelete});}}}}),""==value&&(self.lmn23=true),value;},superChatBackground:function(el){var background=null;return $.each(this.lmn1.superchat,function(canCreateDiscussions,event){if(el>=parseFloat(event.amount.replace(",",".").replace(" ",""))){return background=event.color,false;}}),background;},parseContent:function(text){return this.lmn1.use_editor?text:chatbox.parseContent(text,this.lmn1);},chattersListFormat:function(obj){var value="";var th_field="";var patch3c="";var args=ips.getSetting("chatbox_userFormat");var r=this;return $.each(obj,function(canCreateDiscussions,o){var s=!!r.lmn1.canManage&&o.chatterID!=ips.getSetting("memberID");var c=args[o.chatterGroup].prefix+o.chatterName+args[o.chatterGroup].suffix;if(o.chatterID>0){th_field=(patch3c=ips.getSetting("baseURL")+"index.php?app=core&module=members&controller=profile&id="+o.chatterID)+"&do=hovercard";}
if(!(o.is_anon&&r.lmn1.hideAnon&&!r.lmn1.canManage&&o.chatterID!=ips.getSetting("memberID"))){value=value+ips.templates.render("chatbox.chatter.row",{chatterKey:o.key,chatterID:o.chatterID,chatterIP:o.ip,chatterName:o.chatterName,chatterNameFormat:c,chatterPhoto:o.chatterID>0?o.chatterPhoto:"https://www.gravatar.com/avatar/"+o.chatterPhoto+"?s=32&d=wavatar&r=PG",chatterUrl:o.chatterUrl,memberHovercard:th_field,canBeBlocked:s,privateChat:o.chatterID!=ips.getSetting("memberID")&&o.privateChat,islmn34:r.lmn1.hideAnon?o.is_anon:null});}}),value;},chattersList:function(canCreateDiscussions){if(!$("#chattersList_"+this.lmn2+"_menu").length){$(".chatboxContainer").append(ips.templates.render("chatbox.chatters.list",{roomID:this.lmn2}));}
var self=this;ips.getAjax()(self.lmn3+"&do=chattersList",{type:"post",dataType:"json"}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}
var $context=self.scope.find(".chatbox_chatters_Panel");if($context.hasClass("ipsLoading")){$context.removeClass("ipsLoading");}
$context.find(".ipsDataList").html(self.chattersListFormat(response.list));$(document).trigger("contentChange",[$context]);});},listRooms:function(e,event){(e=event?event.originalEvent:e).preventDefault();if("changeRoom"===$(e.target).attr("data-action")){this.changeRoom(e,event);}},changeRoom:function(msg,data){data.originalEvent.preventDefault();var me=this;var chatboxtitle=$(msg.target).attr("data-newroom");var i=$(msg.target).closest(".bimChatbox").hasClass("inGlobalChat")?1:0;var opt_by=$(msg.target).closest(".cWidgetContainer").length>0?me.scope.closest(".cWidgetContainer").attr("data-orientation"):"";var once=$(msg.target).closest(".bimChatbox").hasClass("minimize");return ips.getAjax()(me.lmn3+"&do=changeRoom",{type:"post",dataType:"json",data:{newroom:chatboxtitle,inGlobal:i,inWidget:opt_by}}).done(function(e){if("error"==e.type){ips.ui.alert.show({message:e.message});}else{if(e.url){window.location.replace(e.url);}else{me.stopUpdate();me.scope.closest(".bimChatbox").replaceWith(e.html);if(!once){$(".room_"+chatboxtitle).removeClass("minimize");}
ips.setSetting("chatbox_"+chatboxtitle,e.config);$(document).trigger("contentChange",[$(".room_"+chatboxtitle)]);$(".chatBar").trigger("resizeBar");}}}),false;},roomOptions:function(b,e){switch((b=e?e.originalEvent:b).preventDefault(),$(b.target).attr("data-action")){case"toggleSound":this.toggleSound(e);break;case"openWindowTab":this.openWindowTab(b,e);break;case"cleanRoom":this.cleanRoom(e);break;case"makeAnnouncement":this.makeAnnouncement(e);break;case"blockedChatters":this.blockedChatters(e);break;case"changeSkin":this.changeSkin(b,e);break;case"changeStyle":this.changeStyle(b,e);break;case"selectSong":this.selectSong(b,e);break;case"archive":window.open($(b.target).attr("href"),"_blank");break;case"leaveRoom":this.leaveRoom(b,e);}},toggleSound:function(event){event.originalEvent.preventDefault();var n=ips.utils.cookie.get("chatbox_nosound_"+this.lmn2);this.scope.find('[data-action="toggleSound"] .fa').replaceWith($("<i/>").addClass("fa").addClass(1!=n?"fa-volume-off":"fa-volume-up").removeClass(1!=n?"fa-volume-up":"fa-volume-off"));if(1==n){ips.utils.cookie.set("chatbox_nosound_"+this.lmn2,0);}else{ips.utils.cookie.set("chatbox_nosound_"+this.lmn2,1);}
ips.ui.flashMsg.show(ips.utils.cookie.get("chatbox_nosound_"+this.lmn2)?ips.getString("chatbox_soundDisabled"):ips.getString("chatbox_soundEnabled"));},openWindowTab:function(arg,event){event.originalEvent.preventDefault();var cssChanges=$(arg.target).closest(".bimChatbox");var postLink=$(arg.target).attr("href");if(postLink){var i=cssChanges.width();var rot=cssChanges.height();var page=$(window).width()/ 2-i / 2;var c=$(window).height()/ 2-rot / 2;if(this.lmn1.use_editor){var params="directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,width="+i+",height="+(rot=rot+25)+",top="+c+", left="+page;}else{params="directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width="+i+",height="+rot+",top="+c+", left="+page;}
window.open(postLink,"chatInPopup",params);}
return false;},cleanRoom:function(event){event.originalEvent.preventDefault();var t=this;return ips.ui.alert.show({type:"confirm",message:ips.getString("chatbox_confirmClean"),icon:"warn",buttons:{ok:ips.getString("chatbox_confirm_yes"),cancel:ips.getString("chatbox_confirm_cancel")},callbacks:{ok:function(){ips.getAjax()(t.lmn3+"&do=cleanRoom").done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{ips.ui.flashMsg.show(ips.getString("chatbox_deleted_all"));t.scope.find("#chatContent").empty();}});}}}),false;},makeAnnouncement:function(event){event.originalEvent.preventDefault();var n=this;var $innerblock=ips.ui.dialog.create({url:n.lmn3+"&do=makeAnnouncement",size:"normal",title:ips.getString("chatbox_announcement"),forceReload:false,destructOnClose:true,callback:function(){$(".chatboxAnnForm").on("submit",function(event){var instanceName;for(instanceName in event.preventDefault(),CKEDITOR.instances){CKEDITOR.instances[instanceName].updateElement();}
var ec_form=$(event.currentTarget);return ips.getAjax()(ec_form.attr("action"),{data:ec_form.serialize(),type:"post",bypassRedirect:true}).done(function(e){if("error"==e.type){ips.ui.alert.show({message:e.message});}else{if(e.title){n.scope.find(".cbAnn").show();n.scope.find(".cbAnn .annTitle").text(e.title);}else{n.scope.find(".cbAnn").hide();}
n.updateChat(true);}}).always(function(canCreateDiscussions){$innerblock.hide();}),false;});}});return $innerblock.show(),false;},leaveRoom:function(data){data.originalEvent.preventDefault();var me=this;return ips.ui.alert.show({type:"confirm",message:ips.getString("chatbox_confirmLeave"),icon:"warn",buttons:{ok:ips.getString("chatbox_confirm_yes"),cancel:ips.getString("chatbox_confirm_cancel")},callbacks:{ok:function(){me.stopUpdate();ips.getAjax()(me.lmn3+"&do=leaveRoom").done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{if("chatbox"!=$("body").attr("data-pageapp")||"room"!=$("body").attr("data-pagecontroller")||me.scope.closest(".bimChatbox").hasClass("inGlobalChat")){me.toggleChat();}else{window.location.replace(ips.getSetting("baseURL"));}}});}}}),false;},blockedChatters:function(event){event.originalEvent.preventDefault();var n=this;return ips.ui.dialog.create({url:n.lmn3+"&do=blockedChatters",size:"normal",title:ips.getString("chatbox_blockedchatters"),forceReload:true,destructOnClose:true,callback:function(){$("[data-action='unblock']").on("click",function(event){return ips.getAjax()(n.lmn3+"&do=unblock",{type:"post",data:{key:$(event.currentTarget).attr("data-key")}}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{$(event.currentTarget).closest(".userRow").remove();}}),false;});}}).show(),false;},addToBlockedList:function(value,current,action,personId){var i=this;var $innerblock=ips.ui.dialog.create({url:i.lmn3+"&do=addToBlockedList&key="+current+"&ip="+personId+"&name="+action,size:"narrow",forceReload:true,destructOnClose:true,callback:function(){$(".chatboxBlockUser").on("submit",function(event){event.preventDefault();var o=$(event.currentTarget);return ips.getAjax()(o.attr("action"),{data:o.serialize(),type:"post",bypassRedirect:true}).done(function(event){ips.ui.flashMsg.show(event.message);if(null!=value){i.scope.find("li#"+value).remove();}
if(1==event.deleted){i.scope.find("[data-key='"+current+"']").closest(".chat_row").remove();}}).always(function(canCreateDiscussions){$innerblock.hide();}),false;});}});return $innerblock.show(),false;},changeSkin:function(args,evt){evt.originalEvent.preventDefault();var skin=$(args.target).data("skin");return $(args.target).closest(".chatboxSkins").find("li").removeClass("skinSelected"),$(args.target).addClass("skinSelected"),$(args.target).closest(".bimChatbox").removeClass(function(canCreateDiscussions,strRect){return(strRect.match(/(^|\s)skin_\S+/g)||[]).join(" ");}),$(args.target).closest(".bimChatbox").addClass("skin_"+skin),ips.utils.cookie.set("chatbox_skin_"+this.lmn2,skin),false;},changeStyle:function(n,event){event.originalEvent.preventDefault();var graph=this;return $(n.target).one("change",function(){var value=this.value;return ips.utils.cookie.set("chatbox_style_"+graph.lmn2,value),graph.updateStyle(),graph.stopUpdate(),graph.connect(),false;}),false;},updateStyle:function(){this.lmn1.style=1==this.lmn1.allow_select_skins&&ips.utils.cookie.get("chatbox_style_"+this.lmn2)?ips.utils.cookie.get("chatbox_style_"+this.lmn2):this.lmn1.style?this.lmn1.style:"standard";},disconnect:function(){return this.lmn27?(ips.ui.alert.show({message:ips.getString("chatbox_can_not_connect")}),this.scope.find("#btnConnect").html(ips.getString("chatbox_reconnect")),this.scope.find("#btnConnect").attr("disabled",false),false):(this.stopUpdate(),this.lmn27=true,this.scope.prepend(ips.templates.render("chatbox.disconnected",{msg:ips.getString("chatbox_disconnected"),btn:ips.getString("chatbox_reconnect")})),false);},connect:function(){return this.scope.find("#btnConnect").attr("disabled",true),this.scope.find("#btnConnect").html('<i class="fa fa-refresh fa-spin"></i> '+ips.getString("chatbox_connecting")),this.scope.find("#chatContent").empty(),this.lmn19=true,this.lmn20=false,this._lastMSG=0,this.updateChat("true"),false;},connected:function(){this.lmn27=false;this.scope.find(".disconnected").remove();ips.ui.flashMsg.show(ips.getString("chatbox_connected"));},kick:function(){return this.stopUpdate(),this.lmn27=true,this.scope.prepend(ips.templates.render("chatbox.disconnected",{msg:ips.getString("chatbox_isblocked")})),false;},toggleInputForm:function(isIron){var $code=this.scope.find(".chatInput");var $aidlBtn=this.scope.find('[data-action="sendMSG"]');if(1==isIron){this.lmn21=false;$aidlBtn.prop("disabled",false);$code.val("");if($code.closest("#chatInputArea").hasClass("expanded")){$code.closest("#chatInputArea").removeClass("expanded");$code.css("height","auto");this.scope.find("#chatContentIframe").height(this.lmn28);this.scope.find("#userListIframe").height(this.lmn28);$(".chatBar").trigger("resizeBar");}}else{this.lmn21=true;$aidlBtn.prop("disabled",true);}},toggleChat:function(){var self=this;return self.scope.closest(".bimChatbox").hasClass("minimize")?(ips.utils.cookie.set("chatbox_room_off_"+self.lmn2,0),self.scope.closest(".bimChatbox").removeClass("minimize"),ips.getSetting("chatbox_member_name")&&1!=self.scope.find(".chatboxRulesWrapper").length&&(self.ping(true),self.lmn19||self.updateChat(true)),$(".chatBar").trigger("resizeBar")):(ips.utils.cookie.set("chatbox_room_off_"+self.lmn2,1),self.scope.closest(".bimChatbox").addClass("minimize"),self.stopUpdate(),self.lmn15=$.now()),false;},toggleOn:function(){var e="chatbox"==$("body").attr("data-pageapp")&&"room"==$("body").attr("data-pagecontroller");if(this.scope.closest(".bimChatbox").hasClass("minimize")&&(e||!e&&1!=ips.utils.cookie.get("chatbox_room_off_"+this.lmn2))){this.toggleChat();}},stopUpdate:function(){clearTimeout(this.lmn6);clearTimeout(this.lmn7);},loadMore:function(event){var n=this;if(n.lmn24){return false;}
var $suggestionContainer=n.scope.find("#chatContentIframe");var content=$suggestionContainer.find("#chatContent");var titleInputId="asc"==n.lmn1.sort?content.children(".chat_row:first").attr("id"):content.children(".chat_row:last").attr("id");return n.lmn24=true,ips.getAjax()(n.lmn3+"&do=getMSG",{dataType:"json",type:"post",data:{lastID:titleInputId||0,loadMoreMode:1}}).done(function(e){if("error"==e.type){ips.ui.alert.show({message:e.message});}else{if(1==e.noMore){$(event.currentTarget).remove();ips.ui.flashMsg.show(ips.getString("chatbox_no_older"));}else{if(e.content){if("asc"==n.lmn1.sort){$(event.currentTarget).after(n.chatRowHTML(e.content));$suggestionContainer.scrollTop(n.scope.find("#"+titleInputId).position().top-50);}else{$(event.currentTarget).before(n.chatRowHTML(e.content));}
$(document).trigger("contentChange",[n.scope.find("#chatContentIframe")]);$(".timeago:not(.loadedAgo)").timeago();}}}}).fail(function(){if(1!=ips.getSetting("chatbox_no_disconnect")){n.disconnect();}}).always(function(){n.lmn23=false;n.lmn24=false;}),false;},autoLoad:function(){if(this.lmn19||!this.lmn18){return false;}
var me=this;var domParent=me.scope.find("#chatContentIframe");var content=domParent.find("#chatContent");if("asc"==this.lmn1.sort){if(!this.lmn30&&0!=domParent.scrollTop()){return false;}
var selectedA=content.children().first().attr("id");}else{if(!this.lmn30&&domParent.scrollTop()+domParent.innerHeight()<domParent[0].scrollHeight){return false;}
selectedA=content.children().last().attr("id");}
if(domParent.find("#loadMore").length<=0){var i=ips.templates.render("chatbox.loadMore");if("asc"==this.lmn1.sort){content.prepend(i);}else{content.append(i);}}
me.lmn30=false;me.lmn18=false;me.lmn24=true;ips.getAjax()(me.lmn3+"&do=getMSG",{dataType:"json",type:"post",data:{lastID:selectedA||0,loadMoreMode:1}}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{if(1==response.noMore){ips.ui.flashMsg.show(ips.getString("chatbox_no_older"));}else{if(response.content){if("asc"==me.lmn1.sort){content.prepend(me.chatRowHTML(response.content));domParent.scrollTop(me.scope.find("#"+selectedA).position().top-50);}else{content.append(me.chatRowHTML(response.content));}
$(document).trigger("contentChange",[me.scope.find("#chatContentIframe")]);$(".timeago:not(.loadedAgo)").timeago();me.lmn18=true;}
if(("asc"==me.lmn1.sort?content.children().first().attr("id"):content.children().last().attr("id"))==selectedA){me.lmn30=true;me.autoLoad();}}}
domParent.find("#loadMore").remove();}).fail(function(){if(1!=ips.getSetting("chatbox_no_disconnect")){me.disconnect();}}).always(function(){me.lmn23=false;me.lmn24=false;});},saveGuestName:function(event){event.preventDefault();var data=this;var a=data.scope.closest(".bimChatbox").hasClass("inGlobalChat")?1:0;var opt_by=data.scope.closest(".cWidgetContainer").length>0?data.scope.closest(".cWidgetContainer").attr("data-orientation"):"";var i=data.scope.find("button");i.attr("disabled",true);i.html('<i class="fa fa-refresh fa-spin"></i> '+ips.getString("chatbox_connecting"));var sel_construtor_name=data.scope.find(".guestName").val();return ips.getAjax()(data.lmn3+"&do=changeName",{type:"post",dataType:"json",data:{name:sel_construtor_name,inGlobal:a,inWidget:opt_by}}).done(function(e){if("error"==e.type||"errorGuestName"==e.type){ips.ui.alert.show({message:e.message});}else{data.scope.closest(".bimChatbox").replaceWith(e.html);if(1==a){$(".room_"+data.lmn2).removeClass("minimize");$(document).trigger("contentChange",[$(".room_"+data.lmn2)]);$(".chatBar").trigger("resizeBar");}
$(document).trigger("contentChange",[$(".room_"+data.lmn2)]);ips.ui.flashMsg.show(e.message);}}).always(function(){i.attr("disabled",false);i.html(ips.getString("chatbox_save_name"));}),false;},acceptRules:function(event){event.preventDefault();var me=this;var a=$(event.currentTarget);var o=me.scope.closest(".bimChatbox").hasClass("inGlobalChat")?1:0;var opt_by=me.scope.closest(".cWidgetContainer").length>0?me.scope.closest(".cWidgetContainer").attr("data-orientation"):"";var showSliderNum=me.scope.closest(".chatBar").length>0?1:0;return ips.getAjax()(a.attr("action"),{data:a.serialize()+"&inGlobal="+o+"&inWidget="+opt_by+"&openFromBar="+showSliderNum,type:"post",bypassRedirect:true}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{me.scope.closest(".bimChatbox").replaceWith(response.html);if(1==o){$(".room_"+me.lmn2).removeClass("minimize");}
$(document).trigger("contentChange",[$(".room_"+me.lmn2)]);$(".chatBar").trigger("resizeBar");}}),false;},mention:function(msg){return msg.preventDefault(),chatbox.mention(msg,this.lmn1.use_editor),false;},enterSubmit:function(ev){if(13===ev.which){return this.clickSubmit(),false;}},clickSubmit:function(){return this.scope.find(".chatboxEditor").submit(),false;},click_addToBlockedList:function(event){var highkey=$(event.currentTarget).attr("data-key");var personId=$(event.currentTarget).attr("data-ip");var c=$(event.currentTarget).attr("data-name");return this.addToBlockedList(null,highkey,c,personId),false;},submitEditor:function(event){event.preventDefault();var n=this;var a=n.scope.find(".chatboxEditor");if(n.lmn21){return false;}
if(n.lmn1.use_editor){var store_scrEncounter=CKEDITOR.instances["chatMSG_"+n.lmn2];var id=store_scrEncounter.getData();}else{id=a.find("textarea").val();id=chatbox.escapeHTML(id);}
return(0!=n.scope.find(".chatboxEditor .ipsAttach_done").length&&!id||0!=n.checkMSG(id))&&0!=n.checkFlood()&&(store_scrEncounter?a.find('button[type="submit"]').prop("disabled",true).text(ips.getString("chatbox_posting")):n.toggleInputForm(0),n.lmn21=true,ips.getAjax()(a.attr("action"),{data:a.serialize(),type:"post",bypassRedirect:true}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});n.lmn21=false;}else{if("errorGuestName"==response.type){n.stopUpdate();location.reload();}else{n.lmn23=true;n.updateChat(true);n.lmn1.lastchat=$.now();$(".chatBar").trigger("resizeBar");}}}).always(function(){n.lmn24=false;n.lmn21=false;n.lmn25=true;if(store_scrEncounter){ips.ui.editor.getObj(n.scope.find('[data-role="chatboxFormArea"] [data-ipsEditor]')).reset();a.find('button[type="submit"]').prop("disabled",false).text(ips.getString("chatbox_send"));}else{n.toggleInputForm(1);n.scope.find(".charCount").hide();if(n.scope.find('#chatInputArea [data-role="deleteFile"]').length>0){n.scope.find('#chatInputArea [data-role="deleteFile"]').each(function(){$(this).click();});}}}),false);},editEditor:function(part){var that=this;var $sharepreview=$(".room_"+that.lmn2);var $innerblock=ips.ui.dialog.create({url:that.lmn3+"&do=editEditor&chatID="+part,size:that.lmn1.use_editor?"normal":"narrow",title:ips.getString("chatbox_edit"),forceReload:true,destructOnClose:true,callback:function(){if(that.lmn1.use_editor){var form=$(".ipsDialog_content .cbEditorEdit");}else{form=$(".ipsDialog_content .cbCleanTextEdit");form.find("textarea").on("keypress",function(event){if(13===event.which){return form.submit(),false;}});}
form.on("submit",function(event){if(event.preventDefault(),that.lmn1.use_editor){var editor=CKEDITOR.instances["chatMSG_"+that.lmn2+"_"+part];editor.updateElement();var id=editor.getData();}else{id=$(this).find("textarea").val();id=chatbox.escapeHTML(id);}
if((0==$(event.currentTarget).find(".ipsAttach_done").length||id)&&0==that.checkMSG(id)){return false;}
var parameters=$(event.currentTarget).serializeArray();return parameters.push({name:"newMsg",value:id}),ips.getAjax()($(event.currentTarget).attr("action"),{data:$.param(parameters),type:"post",bypassRedirect:true}).done(function(e){if("error"==e.type){ips.ui.alert.show({message:e.message});}else{ips.ui.flashMsg.show(ips.getString("chatbox_edited"));$sharepreview.find("#chatRow_"+part+" .chatbox_msg").html(that.parseContent(e.content));$(document).trigger("contentChange",[$sharepreview.find(".chatboxContainer")]);}}).always(function(){$innerblock.hide();}),false;});}});return $innerblock.show(),false;},checkFlood:function(){if(this.lmn1.flood>0&&!this.lmn1.canManage&&!this.lmn1.canBypassFlood){var first_cell_percentage=($.now()-this.lmn1.lastchat)/ 1E3;if(first_cell_percentage<this.lmn1.flood){return ips.ui.alert.show({message:ips.getString("chatbox_error_flood",{time:(this.lmn1.flood-first_cell_percentage).toFixed(2)})}),0;}}
return 1;},checkMSG:function(headers){headers=headers.trim();var i=this.lmn1.length;return headers.length<=0?(ips.ui.alert.show({message:ips.getString("chatbox_error_empty")}),0):i>0&&headers.length>i?(ips.ui.alert.show({message:ips.pluralize(ips.getString("chatbox_error_maxlength"),i)}),0):1;},selectSong:function(e){e.originalEvent.preventDefault();var scope=this;return ips.ui.dialog.create({url:scope.lmn3+"&do=selectSong",size:"narrow",title:ips.getString("chatbox_selectSong"),forceReload:true,destructOnClose:true,callback:function(){$(document).on("click",'[data-action="addSong"]',ds.bind(scope.addSong,scope));$(document).on("click",'[data-action="removeSong"]',ds.bind(scope.removeSong,scope));$(document).on("focus",'[data-role="searchSong"]',ds.bind(scope.focusSongSearch,scope));$(document).on("blur",'[data-role="searchSong"]',ds.bind(scope.blurSongSearch,scope));}}).show(),false;},focusSongSearch:function(canCreateDiscussions){this.lmn13=setInterval(ds.bind(this._checkSongValue,this),700);},blurSongSearch:function(canCreateDiscussions){clearInterval(this.lmn13);},_checkSongValue:function(){var expRecords=$('[data-role="searchSong"]').val();if(expRecords!=this.lmn14&&!(expRecords.length<4)){this.lmn14=expRecords;if(this._ajax&&this._ajax.abort){this._ajax.abort();}
this._ajax=ips.getAjax()(this.lmn3+"&do=searchSong",{data:{q:this.lmn14},type:"post"}).done(function(usersLayoutTemplate){$('[data-role="songResults"]').html(usersLayoutTemplate);$(document).trigger("contentChange",[$('[data-role="songResults"]')]);});}},addSong:function(obj){$(obj.currentTarget).closest(".ipsDataItem").attr("data-songID");var player=this;return this._ajax=ips.getAjax()(player.lmn3+"&do=addSong",{data:{song:$(obj.currentTarget).closest(".ipsDataItem").attr("data-songID")},type:"post"}).done(function(data){if("error"==data.type){ips.ui.alert.show({message:data.message});}else{var $el=$(obj.currentTarget).closest(".chatboxSongs").find('[data-role="playingSong"]');$el.html(data.html);$(document).trigger("contentChange",[$el]);var songs=data.song;if(songs.id!=player.lmn12){player.lmn1.song=songs;}
player.playSong();}}),false;},removeSong:function(event){$(event.currentTarget).closest(".ipsDataItem").attr("data-songID");var n=this;return this._ajax=ips.getAjax()(n.lmn3+"&do=removeSong",{data:{song:$(event.currentTarget).closest(".ipsDataItem").attr("data-songID")},type:"post"}).done(function(response){if("error"==response.type){ips.ui.alert.show({message:response.message});}else{$(event.currentTarget).closest(".chatboxSongs").find('[data-role="playingSong"]').html("");n.hideMusicPlayer();$(".chatBar").trigger("resizeBar");}}),false;},playSong:function(){if(!this.lmn1.song){return false;}
var info=$.parseJSON(this.lmn1.song);var $sharepreview=$(".room_"+this.lmn2);var player=$sharepreview.find("#chatbox-player");if(this.lmn12>0&&this.lmn12==info.id){return false;}
this.lmn12=info.id;$sharepreview.find(".chatboxMusicPlayer").removeClass("ipsHide");$(".chatBar").trigger("resizeBar");player.jPlayer("stop");$sharepreview.find("#current-song-name").html(info.name);$sharepreview.find("#current-artist-name").html(info.artist);$sharepreview.find("#topbar-artwork").html('<img src="'+info.thumbnail+'">');if(info.file.toLowerCase().indexOf(".mp3")>=0){player.jPlayer("setMedia",{mp3:info.file}).jPlayer("play",1);}else{if(info.file.toLowerCase().indexOf("m4a")>=0){player.jPlayer("setMedia",{m4a:info.file}).jPlayer("play",1);}else{if(info.file.toLowerCase().indexOf("wma")>=0){player.jPlayer("setMedia",{wma:info.file}).jPlayer("play",1);}}}},hideMusicPlayer:function(){this.scope.find("#chatbox-player").jPlayer("stop");this.scope.find(".chatboxMusicPlayer").addClass("ipsHide");self.lmn12=0;},jPlayer:function(){if(this.scope.find("#chatbox-player").length){this.scope.find("#chatbox-player").jPlayer({cssSelectorAncestor:"#sound-container",swfPath:ips.getSetting("baseURL")+"applications/musicbox/interface/jPlayer",supplied:"mp3,wma,m4a",wmode:"window",volume:ips.utils.db.get("musicbox","volume")?ips.utils.db.get("musicbox","volume"):.5,smoothPlayBar:true,consoleAlerts:false,loop:true});this.playSong();}},resizeWindow:function(){if(this.scope.closest(".chatBar").length>0){if(this.scope.closest(".chatBar").is(":hidden")){if(!this.lmn26){this.toggleChat();}
this.lmn26=true;}else{this.lmn26=false;}}},goDown:function(){var t=this;var $el=t.scope.find("#chatContentIframe");t.scope.find("#chatContent");if(!t.lmn24){$el.scrollTop($el.prop("scrollHeight"));}
if(!t.lmn11){$el.find("img").imagesLoaded(function(n){if(!t.lmn24){$el.scrollTop($el.prop("scrollHeight"));}});}},donate:function(to){var $scope=this;var $innerblock=ips.ui.dialog.create({url:$scope.lmn3+"&do=donate",size:"narrow",forceReload:false,destructOnClose:true,callback:function(e){$(e).find("form").on("submit",function(event){event.preventDefault();var o=$(event.currentTarget);return ips.getAjax()(o.attr("action"),{data:o.serialize(),type:"post",bypassRedirect:true}).done(function($stateParams){if($stateParams.redirect){$scope.lmn29=$stateParams.redirect;$innerblock.hide();if(chatbox.isExternal($scope.lmn29)){window.location.href=$scope.lmn29;}else{$scope.checkoutDialog($scope.lmn29);}}}).always(function(canCreateDiscussions){}),false;});}});return $innerblock.show(),false;},checkoutDialog:function(e){var self=this;var $innerblock=ips.ui.dialog.create({url:e,size:"normal",forceReload:false,destructOnClose:true,callback:function(e){$(e).find('a[data-action="wizardLink"]').on("click",function(event){return $innerblock.hide(),self.checkoutDialog($(event.currentTarget).attr("href")),false;});$(e).find("form").on("submit",function(event){event.preventDefault();var o=$(event.currentTarget);return ips.getAjax()(o.attr("action"),{data:o.serialize(),type:"post",bypassRedirect:true}).done(function(options){var value=options.redirect?options.redirect:self.lmn29;$innerblock.hide();if(chatbox.isExternal(value)){window.location.href=value;}else{self.checkoutDialog(value);}}),false;});}});$innerblock.show();}});}(jQuery,_);;
$(document).ready(function(){var tabCount=ips.getSetting('chatbox_tabCount');if(tabCount>-1){var chatMenu=$('[data-role="navBarItem"][data-navApp="chatbox"][data-navExt="Chatbox"] > a');if(chatMenu.length>0){chatMenu.append($('<span/>').addClass('ipsNotificationCount chatboxTabCount cbTabCount_'+tabCount).text(tabCount));setInterval(function(){ips.getAjax()(ips.getSetting('baseURL')+'index.php?app=chatbox&module=chatbox&controller=chatbox&do=tabCount').done(function(response){if(self._joined!=1){if(response.count>0){$('.chatboxTabCount').text(response.count).removeClass('cbTabCount_0');}
else $('.chatboxTabCount').text('0').addClass('cbTabCount_0');}});},15000);}}});;
ips.templates.set('chatbox.style.superchat'," <li class='ipsDataItem {{#id}}chat_row{{/id}} {{#callme}}mentionMe{{/callme}}' {{#id}}id='{{id}}'{{/id}}> <div class='superchat' data-amount='{{money}}' style='background: {{mainBg}};'>  <div class='{{#chatterPhoto}}ipsPhotoPanel ipsPhotoPanel_tiny{{/chatterPhoto}} ipsClearfix'>   <a href='#' data-member='{{chatterName}}' data-id='{{chatterID}}' data-url='{{chatterUrl}}' {{#memberHovercard}}data-ipshover data-ipshover-target='{{memberHovercard}}' data-ipsHover-onClick{{/memberHovercard}} class='ipsUserPhoto ipsUserPhoto_tiny' id='ips_uid_{{chatterID}}'>    <img src='{{chatterPhoto}}' alt=''>   </a>   <div>    <a href='#' class='chatterName' style='color: #{{mainTxt}};' data-action='mention' data-member='{{chatterName}}' data-id='{{chatterID}}' data-url='{{chatterUrl}}' {{#memberHovercard}}data-ipshover data-ipshover-target='{{memberHovercard}}'{{/memberHovercard}}>     {{{chatterNameFormat}}}    </a>    <div class='ipsPos_right' style='color: #{{mainTxt}};'>     <time class='cbTime {{#inDay}}timeago{{/inDay}} ipsType_small ipsType_light' datetime='{{time}}'>{{time}}</time>&nbsp;     {{#id}}      {{#canManageMSG}}       <a class='msgAction' href='#msgAction{{id}}_menu' id='msgAction{{id}}' data-action='options' data-ipsMenu data-ipsMenu-closeOnClick='false' data-ipsMenu-appendTo='.chatboxContainer'>        <i class='fa fa-ellipsis-h'></i>       </a>       <ul class='cbMsgActionMenu ipsMenu ipsMenu_auto ipsHide' id='msgAction{{id}}_menu'>        {{#canEdit}}<li class='ipsMenu_item'><a href='#' data-action='edit' data-chatID='{{id}}'>{{#lang}}chatbox_edit{{/lang}}</a></li>{{/canEdit}}        {{#canDelete}}<li class='ipsMenu_item'><a href='#' data-action='delete' data-chatID='{{id}}'>{{#lang}}chatbox_delete{{/lang}}</a></li>{{/canDelete}}        {{#canReport}}<li class='ipsMenu_item'><a href='#' data-action='report' data-chatID='{{id}}'>{{#lang}}chatbox_report{{/lang}}</a></li>{{/canReport}}        {{#canBeBlocked}}<li class='ipsMenu_item'><a href='#' data-action='addToBlockedList' data-key='{{chatterKey}}' data-ip='{{chatterIP}}' data-name='{{chatterName}}'>{{#lang}}chatbox_block{{/lang}}</a></li>{{/canBeBlocked}}       </ul>      {{/canManageMSG}}     {{/id}}    </div>    <div class='ipsList_inline'><span class='money' style='color: #{{mainTxt}};'>{{money}}</span></div>   </div>  </div>  <div id='chatRow_{{id}}' data-id='{{id}}' class='msgArea' style='color: #{{mainTxt}}; background-color: {{subBg}}'><span class='chatbox_msg'>{{{content}}}</span></div> </div></li>");ips.templates.set('chatbox.style.standard'," <li class='ipsDataItem {{#id}}chat_row{{/id}} chatbox_style1 {{#callme}}mentionMe{{/callme}}' {{#id}}id='{{id}}'{{/id}}> <div class='ipsPadding:half {{#chatterPhoto}}ipsPhotoPanel ipsPhotoPanel_tiny{{/chatterPhoto}} ipsClearfix'>  <a href='#' data-member='{{chatterName}}' data-id='{{chatterID}}' data-url='{{chatterUrl}}' {{#memberHovercard}}data-ipshover data-ipshover-target='{{memberHovercard}}' data-ipsHover-onClick{{/memberHovercard}} class='ipsUserPhoto ipsUserPhoto_tiny' id='ips_uid_{{chatterID}}'>   <img src='{{chatterPhoto}}' alt=''>  </a>  <div>   <a href='#' class='chatterName' data-action='mention' data-member='{{chatterName}}' data-id='{{chatterID}}' data-url='{{chatterUrl}}' {{#memberHovercard}}data-ipshover data-ipshover-target='{{memberHovercard}}'{{/memberHovercard}}>{{{chatterNameFormat}}}</a>   <div class='ipsPos_right'>    <time class='cbTime {{#inDay}}timeago{{/inDay}} ipsType_small ipsType_light' datetime='{{time}}'>{{time}}</time>&nbsp;    {{#id}}     {{#canManageMSG}}      <a class='msgAction' href='#msgAction{{id}}_menu' id='msgAction{{id}}' data-action='options' data-ipsMenu data-ipsMenu-closeOnClick='false' data-ipsMenu-appendTo='.chatboxContainer'>       <i class='fa fa-ellipsis-h'></i>      </a>      <ul class='cbMsgActionMenu ipsMenu ipsMenu_auto ipsHide' id='msgAction{{id}}_menu'>       {{#canEdit}}<li class='ipsMenu_item'><a href='#' data-action='edit' data-chatID='{{id}}'>{{#lang}}chatbox_edit{{/lang}}</a></li>{{/canEdit}}       {{#canDelete}}<li class='ipsMenu_item'><a href='#' data-action='delete' data-chatID='{{id}}'>{{#lang}}chatbox_delete{{/lang}}</a></li>{{/canDelete}}       {{#canReport}}<li class='ipsMenu_item'><a href='#' data-action='report' data-chatID='{{id}}'>{{#lang}}chatbox_report{{/lang}}</a></li>{{/canReport}}       {{#canBeBlocked}}<li class='ipsMenu_item'><a href='#' data-action='addToBlockedList' data-key='{{chatterKey}}' data-ip='{{chatterIP}}' data-name='{{chatterName}}'>{{#lang}}chatbox_block{{/lang}}</a></li>{{/canBeBlocked}}      </ul>     {{/canManageMSG}}    {{/id}}   </div>   <div class='ipsList_inline' id='chatRow_{{id}}' data-id='{{id}}'><span class='chatbox_msg'>{{{content}}}</span></div>  </div> </div></li>");ips.templates.set('chatbox.style.condensed'," <li class='ipsDataItem {{#id}}chat_row{{/id}} chatbox_style2 {{#callme}}mentionMe{{/callme}}' {{#id}}id='{{id}}'{{/id}}> <div class='ipsPadding:half ipsClearfix'>  <a href='#' class='chatterName' data-action='mention' data-member='{{chatterName}}' data-id='{{chatterID}}' data-url='{{chatterUrl}}'>{{{chatterNameFormat}}}</a>:    <span class='ipsPos_right'>   <time class='cbTime {{#inDay}}timeago{{/inDay}} ipsType_small ipsType_light' datetime='{{time}}'>{{time}}</time>&nbsp;   {{#id}}    {{#canManageMSG}}     <a class='msgAction' href='#msgAction{{id}}_menu' id='msgAction{{id}}' data-action='options' data-ipsMenu data-ipsMenu-closeOnClick='false' data-ipsMenu-appendTo='.chatboxContainer'>      <i class='fa fa-ellipsis-h'></i>     </a>     <ul class='cbMsgActionMenu ipsMenu ipsMenu_auto ipsHide' id='msgAction{{id}}_menu'>      {{#canEdit}}<li class='ipsMenu_item'><a href='#' data-action='edit' data-chatID='{{id}}'>{{#lang}}chatbox_edit{{/lang}}</a></li>{{/canEdit}}      {{#canDelete}}<li class='ipsMenu_item'><a href='#' data-action='delete' data-chatID='{{id}}'>{{#lang}}chatbox_delete{{/lang}}</a></li>{{/canDelete}}      {{#canReport}}<li class='ipsMenu_item'><a href='#' data-action='report' data-chatID='{{id}}'>{{#lang}}chatbox_report{{/lang}}</a></li>{{/canReport}}      {{#canBeBlocked}}<li class='ipsMenu_item'><a href='#' data-action='addToBlockedList' data-key='{{chatterKey}}' data-ip='{{chatterIP}}' data-name='{{chatterName}}'>{{#lang}}chatbox_block{{/lang}}</a></li>{{/canBeBlocked}}     </ul>    {{/canManageMSG}}   {{/id}}  </span>  <span id='chatRow_{{id}}' data-id='{{id}}'><span class='chatbox_msg'>{{{content}}}</span></span> </div></li>");ips.templates.set('chatbox.style.bubbles'," <li class='ipsDataItem {{#id}}chat_row{{/id}} chatbox_style3 {{#callme}}mentionMe{{/callme}}' {{#id}}id='{{id}}'{{/id}}> <div class='ipsPadding:half {{#chatterPhoto}}ipsPhotoPanel ipsPhotoPanel_tiny{{/chatterPhoto}} ipsClearfix'>  <a href='#' data-member='{{chatterName}}' data-id='{{chatterID}}' data-url='{{chatterUrl}}' {{#memberHovercard}}data-ipshover data-ipshover-target='{{memberHovercard}}' data-ipsHover-onClick{{/memberHovercard}} class='ipsUserPhoto ipsUserPhoto_tiny' id='ips_uid_{{chatterID}}'>   <img src='{{chatterPhoto}}' alt=''>  </a>  <div class='ipsClearfix'>   <div class='bubble cb1' id='chatRow_{{id}}' data-id='{{id}}'>    <a href='#' class='chatterName ipsType_reset' data-action='mention' data-member='{{chatterName}}' data-id='{{chatterID}}' data-url='{{chatterUrl}}' {{#memberHovercard}}data-ipshover data-ipshover-target='{{memberHovercard}}'{{/memberHovercard}}>{{{chatterNameFormat}}}:</a>     <span class='chatbox_msg'>{{{content}}}</span>   </div>   <br>   <span class='ipsPos_right'>    <time class='cbTime {{#inDay}}timeago{{/inDay}} ipsType_small ipsType_light' datetime='{{time}}'>{{time}}</time>&nbsp;    {{#id}}     {{#canManageMSG}}      <a class='msgAction' href='#msgAction{{id}}_menu' id='msgAction{{id}}' data-action='options' data-ipsMenu data-ipsMenu-closeOnClick='false' data-ipsMenu-appendTo='.chatboxContainer'>       <i class='fa fa-ellipsis-h'></i>      </a>      <ul class='cbMsgActionMenu ipsMenu ipsMenu_auto ipsHide' id='msgAction{{id}}_menu'>       {{#canEdit}}<li class='ipsMenu_item'><a href='#' data-action='edit' data-chatID='{{id}}'>{{#lang}}chatbox_edit{{/lang}}</a></li>{{/canEdit}}       {{#canDelete}}<li class='ipsMenu_item'><a href='#' data-action='delete' data-chatID='{{id}}'>{{#lang}}chatbox_delete{{/lang}}</a></li>{{/canDelete}}       {{#canReport}}<li class='ipsMenu_item'><a href='#' data-action='report' data-chatID='{{id}}'>{{#lang}}chatbox_report{{/lang}}</a></li>{{/canReport}}       {{#canBeBlocked}}<li class='ipsMenu_item'><a href='#' data-action='addToBlockedList' data-key='{{chatterKey}}' data-ip='{{chatterIP}}' data-name='{{chatterName}}'>{{#lang}}chatbox_block{{/lang}}</a></li>{{/canBeBlocked}}      </ul>     {{/canManageMSG}}    {{/id}}   </span>  </div> </div></li>");ips.templates.set('chatbox.style.talkie'," <li class='{{#id}}chat_row{{/id}} chatbox_style4 {{#callme}}mentionMe{{/callme}}' {{#id}}id='{{id}}'{{/id}}> {{^isMe}}  <div class='ipsPadding:half {{#chatterPhoto}}ipsPhotoPanel ipsPhotoPanel_tiny{{/chatterPhoto}} ipsClearfix'>   <a href='#' data-member='{{chatterName}}' data-id='{{chatterID}}' data-url='{{chatterUrl}}' {{#memberHovercard}}data-ipshover data-ipshover-target='{{memberHovercard}}' data-ipsHover-onClick{{/memberHovercard}} class='ipsUserPhoto ipsUserPhoto_tiny' id='ips_uid_{{chatterID}}'>    <img src='{{chatterPhoto}}' alt=''>   </a>   <div class='ipsClearfix'>    <div class='talkie bubbleHim' id='chatRow_{{id}}' data-id='{{id}}'>     <a href='#' class='chatterName ipsType_reset' data-action='mention' data-member='{{chatterName}}' data-id='{{chatterID}}' data-url='{{chatterUrl}}' {{#memberHovercard}}data-ipshover data-ipshover-target='{{memberHovercard}}'{{/memberHovercard}}>{{{chatterNameFormat}}}:</a>     <span class='chatbox_msg'>{{{content}}}</span>    </div>   </div>   <div class='msgInfo'>    <time class='cbTime {{#inDay}}timeago{{/inDay}} ipsType_small ipsType_light' datetime='{{time}}'>{{time}}</time>&nbsp;    {{#id}}     {{#canManageMSG}}      <a class='msgAction' href='#msgAction{{id}}_menu' id='msgAction{{id}}' data-action='options' data-ipsMenu data-ipsMenu-closeOnClick='false' data-ipsMenu-appendTo='.chatboxContainer'>       <i class='fa fa-ellipsis-h'></i>      </a>      <ul class='cbMsgActionMenu ipsMenu ipsMenu_auto ipsHide' id='msgAction{{id}}_menu'>       {{#canEdit}}<li class='ipsMenu_item'><a href='#' data-action='edit' data-chatID='{{id}}'>{{#lang}}chatbox_edit{{/lang}}</a></li>{{/canEdit}}       {{#canDelete}}<li class='ipsMenu_item'><a href='#' data-action='delete' data-chatID='{{id}}'>{{#lang}}chatbox_delete{{/lang}}</a></li>{{/canDelete}}       {{#canReport}}<li class='ipsMenu_item'><a href='#' data-action='report' data-chatID='{{id}}'>{{#lang}}chatbox_report{{/lang}}</a></li>{{/canReport}}       {{#canBeBlocked}}<li class='ipsMenu_item'><a href='#' data-action='addToBlockedList' data-key='{{chatterKey}}' data-ip='{{chatterIP}}' data-name='{{chatterName}}'>{{#lang}}chatbox_block{{/lang}}</a></li>{{/canBeBlocked}}      </ul>     {{/canManageMSG}}    {{/id}}   </span>  </div> {{/isMe}} {{#isMe}}  <div class='ipsPadding:half ipsClearfix'>   <div class='ipsClearfix'>    <div class='talkie bubbleMe' id='chatRow_{{id}}' data-id='{{id}}'>     <span class='chatbox_msg'>{{{content}}}</span>    </div>   </div>   <div class='msgInfo ipsType_right'>    <time class='cbTime {{#inDay}}timeago{{/inDay}} ipsType_small ipsType_light' datetime='{{time}}'>{{time}}</time>&nbsp;    {{#id}}     {{#canManageMSG}}      <a class='msgAction' href='#msgAction{{id}}_menu' id='msgAction{{id}}' data-action='options' data-ipsMenu data-ipsMenu-closeOnClick='false' data-ipsMenu-appendTo='.chatboxContainer'>       <i class='fa fa-ellipsis-h'></i>      </a>      <ul class='cbMsgActionMenu ipsMenu ipsMenu_auto ipsHide' id='msgAction{{id}}_menu'>       {{#canEdit}}<li class='ipsMenu_item'><a href='#' data-action='edit' data-chatID='{{id}}'>{{#lang}}chatbox_edit{{/lang}}</a></li>{{/canEdit}}       {{#canDelete}}<li class='ipsMenu_item'><a href='#' data-action='delete' data-chatID='{{id}}'>{{#lang}}chatbox_delete{{/lang}}</a></li>{{/canDelete}}       {{#canReport}}<li class='ipsMenu_item'><a href='#' data-action='report' data-chatID='{{id}}'>{{#lang}}chatbox_report{{/lang}}</a></li>{{/canReport}}       {{#canBeBlocked}}<li class='ipsMenu_item'><a href='#' data-action='addToBlockedList' data-key='{{chatterKey}}' data-ip='{{chatterIP}}' data-name='{{chatterName}}'>{{#lang}}chatbox_block{{/lang}}</a></li>{{/canBeBlocked}}      </ul>     {{/canManageMSG}}    {{/id}}   </div>  </div> {{/isMe}}</li>");ips.templates.set('chatbox.style.room.system'," <li class='ipsDataItem {{#id}}chat_row{{/id}} system_chat' {{#id}}id='{{id}}'{{/id}}> <div class='ipsPadding:half ipsClearfix'>  <span class='chatbox_msg ipsType_light' id='chatRow_{{id}}' {{#id}}id='{{id}}'{{/id}}><i class='fa fa-angle-double-right'></i> {{{content}}}</span>  <span class='ipsPos_right'>   <time class='cbTime {{#inDay}}timeago{{/inDay}} ipsType_small ipsType_light' datetime='{{time}}'>{{time}}</time>&nbsp;   {{#canDelete}}    {{#canDelete}}     <a class='msgAction' href='#msgAction{{id}}_menu' id='msgAction{{id}}' data-action='options' data-ipsMenu data-ipsMenu-closeOnClick='false' data-ipsMenu-appendTo='.chatboxContainer'>      <i class='fa fa-ellipsis-h'></i>     </a>     <ul class='cbMsgActionMenu ipsMenu ipsMenu_auto ipsHide' id='msgAction{{id}}_menu'>      {{#canDelete}}<li class='ipsMenu_item'><a href='#' data-action='delete' data-chatID='{{id}}'>{{#lang}}chatbox_delete{{/lang}}</a></li>{{/canDelete}}     </ul>    {{/canDelete}}   {{/canDelete}}  </span> </div></li>");ips.templates.set('chatbox.style.con.system'," <li class='ipsDataItem {{#id}}chat_row{{/id}} system_chat' {{#id}}id='{{id}}'{{/id}}> <div class='ipsPadding:half ipsClearfix'>  <span class='chatbox_msg ipsType_light ipsType_small' id='chatRow_{{id}}' {{#id}}id='{{id}}'{{/id}}>   <i class='fa fa-angle-double-right'></i> {{{content}}}  </span>  <span class='ipsPos_right'>   {{#canDelete}}    <a class='msgAction' href='#msgAction{{id}}_menu' id='msgAction{{id}}' data-action='options' data-ipsMenu data-ipsMenu-closeOnClick='false' data-ipsMenu-appendTo='.chatboxContainer'>     <i class='fa fa-ellipsis-h'></i>    </a>    <ul class='cbMsgActionMenu ipsMenu ipsMenu_auto ipsHide' id='msgAction{{id}}_menu'>     {{#canDelete}}<li class='ipsMenu_item'><a href='#' data-action='delete' data-chatID='{{id}}'>{{#lang}}chatbox_delete{{/lang}}</a></li>{{/canDelete}}    </ul>   {{/canDelete}}  </span> </div></li>");ips.templates.set('chatbox.disconnected'," <div class='disconnected'> <span>  <i class='fa fa-exclamation-triangle'></i><br>  {{msg}}<br>  {{#btn}}   <a href='#' id='btnConnect' class='ipsButton ipsButton_primary ipsButton_verySmall ipsMargin_top:half' data-action='connect'>{{btn}}</a>  {{/btn}} </span></div>");ips.templates.set('chatbox.chatters.list'," <ul class='ipsMenu ipsMenu_normal menuChatters' id='chattersList_{{roomID}}_menu' style='display: none'> <li class='ipsMenu_title'>{{#lang}}chatbox_online_users{{/lang}}</li> <div class='ipsMenu_innerContent chatters_content'>  <div class='ipsLoading chatbox_chatters_Panel'>   <ul class='ipsDataList'></ul>  </div> </div></ul>");ips.templates.set('chatbox.chatter.row'," <li class='ipsDataItem chatter_row'> <div class='ipsPadding:half ipsPhotoPanel ipsPhotoPanel_tiny ipsClearfix'>  <a href='#' data-member='{{chatterName}}' data-id='{{chatterID}}' data-url='{{chatterUrl}}' {{#memberHovercard}}data-ipshover data-ipshover-target='{{memberHovercard}}' data-ipsHover-onClick{{/memberHovercard}} class='ipsUserPhoto ipsUserPhoto_tiny' id='ips_uid_{{chatterID}}'>   <img src='{{chatterPhoto}}' alt=''>  </a>  <div class='nameInList ipsClearfix'>   <a href='#' class='username' data-action='mention' data-member='{{chatterName}}' data-id='{{chatterID}}' data-url='{{chatterUrl}}' {{#memberHovercard}}data-ipshover data-ipshover-target='{{memberHovercard}}'{{/memberHovercard}}>    {{#is_anon}}<span class='cb_isAnon ipsType_light' data-ipsTooltip title='{{#lang}}chatbox_is_anon{{/lang}}'><i class='fa fa-eye-slash'></i></span>&nbsp;{{/is_anon}}    {{{chatterNameFormat}}}   </a>   <div class='ipsList_inline'>    {{#privateChat}}     <span data-controller='bim.chatbox.startChat'>      <a href='#' class='ipsButton ipsButton_positive ipsButton_verySmall' data-action='startChat' data-memberID='{{chatterID}}'>       <i class='fa fa-comment'></i> {{#lang}}chatbox_send_private{{/lang}}      </a>&nbsp;     </span>    {{/privateChat}}    {{#canBeBlocked}}     <a href='#' class='ipsButton ipsButton_negative ipsButton_verySmall' data-action='addToBlockedList' data-key='{{chatterKey}}' data-ip='{{chatterIP}}' data-name='{{chatterName}}'>      <i class='fa fa-ban'></i> {{#lang}}chatbox_block{{/lang}}     </a>    {{/canBeBlocked}}   </div>  </div> </div></li>");ips.templates.set('chatbox.parseImage'," <a href='{{url}}' class='mitem' data-action='zoomImage'> {{#blankImage}}  <img src='{{blankImage}}' data-src='{{url}}' class='lazyload'> {{/blankImage}} {{^blankImage}}  <img src='{{url}}'> {{/blankImage}}</a>");ips.templates.set('chatbox.parseURL',"<a href='{{url}}' target='_blank' class='chatboxURL' rel='noopener noreferrer'>{{text}}</a>");ips.templates.set('chatbox.parseVideo'," <div class='chatboxVideoContainer mitem' data-source='{{source}}' data-url='{{url}}' data-play='{{play}}' data-id='{{id}}' data-img='{{img}}' data-html5='{{html5}}'> <div class='chatboxVideo {{#isShorts}}youtubeShorts{{/isShorts}}'>  {{#img}}   {{#blankImage}}    <img src='{{blankImage}}' data-src='{{img}}' class='lazyload'>   {{/blankImage}}   {{^blankImage}}    <img src='{{img}}'>   {{/blankImage}}   <a href='#' data-action='playVideoInIframe'></a>  {{/img}}  {{^img}}   {{#html5}}    <video class='chatboxPlayer' width='100%' height='100%' controls>     <source src='{{play}}' autostart='false'>    </video>   {{/html5}}   {{^html5}}    <iframe class='chatboxPlayer' width='100%' height='100%' src='{{play}}' frameborder='0' allow='autoplay; encrypted-media' allowfullscreen></iframe>   {{/html5}}  {{/img}} </div> <a class='chatboxVideoPopupOpen' data-action='playVideoInPopup'>  <i class='fa fa-window-maximize' aria-hidden='true'></i>&nbsp;&nbsp;{{#lang}}chatbox_expandPlayer{{/lang}} </a></div>");ips.templates.set('chatbox.videoIframe',"  {{#html5}}  <video class='chatboxPlayer' width='100%' height='100%' controls>   <source src='{{play}}'>  </video> {{/html5}} {{^html5}}  <iframe class='chatboxPlayer' width='100%' height='100%' src='{{play}}' frameborder='0' allow='autoplay; encrypted-media' allowfullscreen></iframe> {{/html5}}");ips.templates.set('chatbox.videoPopup'," <div class='chatboxVideoWrapper videopopup_{{chatID}}'> <iframe width='560' height='315' src='{{play}}' frameborder='0' allow='autoplay; encrypted-media' allowfullscreen></iframe></div>");ips.templates.set('chatbox.parseAudio'," <div class='chatboxVideoContainer mitem'> <audio {{#isMemo}}class='cbVoiceMsg'{{/isMemo}} src='{{url}}' controls></audio></div>");ips.templates.set('chatbox.parseGiphy'," <div class='bimGiphyContainer mitem'> <div class='giphy'> {{#blankImage}}  <a href='{{gif}}' data-ipslightbox><img class='ipsImage bimGiphyIMG' src='{{blankImage}}' data-src='{{still}}' class='lazyload'></a> {{/blankImage}} {{^blankImage}}  <a href='{{gif}}' data-ipslightbox><img class='ipsImage bimGiphyIMG' src='{{still}}'></a> {{/blankImage}} <div class='giphyPlayBtn'></div> </div></div>");ips.templates.set('chatbox.editInput'," <textarea type='text' class='editChatInput' data-action='doEdit' autocomplete='off'></textarea>");ips.templates.set('chatbox.loadMore'," <li id='loadMore' class='ipsDataItem ipsType_center ipsPadding'><span class='ipsLoading ipsLoading_tiny'></span></li>");ips.templates.set('chatbox.loadMoreBtn'," <li id='loadMoreBtn' class='ipsDataItem ipsType_center ipsCursor_pointer ipsAreaBackground_light' data-action='loadMore'> {{#lang}}chatbox_loadMoreBtn{{/lang}}</li>");ips.templates.set('chatbox.convo.list.rooms'," <li class='ipsDataItem rooms ipsPadding:half ipsClearfix ipsCursor_pointer' data-action='openRoom' data-roomID='{{id}}'> <a href='#' class='ipsPos_left ipsType_blendLinks' title='{{title}}'>  <i class='fa fa-{{icon}}'></i> {{title}} </a> {{#users}}<span class='ipsPos_right ipsBadge ipsBadge_positive'>{{users}}</span>{{/users}}</li>");ips.templates.set('chatbox.blankRoom'," <div class='room_{{roomID}}'></div>");ips.templates.set('chatbox.blankCon'," <div class='convo_{{conID}}'></div>");ips.templates.set('chatbox.newcon.chats'," <li class='ipsDataItem convoRow ipsClearfix ipsCursor_pointer {{#unread}}mentionMe{{/unread}} convoRow_{{id}}' data-action='openConversation' data-conID='{{id}}'> <div class='{{^isGroup}}ipsPhotoPanel ipsPhotoPanel_tiny{{/isGroup}}'>  {{#isGroup}}   {{{icon}}}  {{/isGroup}}  {{^isGroup}}   <span class='chatbox_one_avatar'>    <i class='fa fa-circle ipsOnlineStatus_online {{^isOnline}}ipsHide{{/isOnline}}'></i>    <span class='ipsUserPhoto ipsUserPhoto_tiny'><img src='{{icon}}'></span>   </span>  {{/isGroup}}  <div class='ipsClearfix convoRowMain'>   <span class='ipsPos_left conRowName' title='{{{name}}}'>    <b>{{{name}}}</b> <span class='newMsgCountTxt'>{{#unread}}({{unread}}){{/unread}}</span>   </span>   <time class='cbTime {{#inDay}}timeago{{/inDay}} ipsPos_right ipsType_small ipsType_light' datetime='{{lastMsgTime}}'>{{lastMsgTime}}</time>&nbsp;   {{#lastMsg}}<br><div class='cbLastMSG ipsType_light'>{{lastMsg}}</div>{{/lastMsg}}  </div> </div></li>");ips.templates.set('chatbox.newcon.temp'," <li class='convoRow tempCon ipsClearfix ipsCursor_pointer convoRow_{{id}}' data-action='openConversation' data-conID='{{id}}'></li>");ips.templates.set('chatbox.newcon.mem'," <li class='convoRow ipsClearfix ipsCursor_pointer' {{^isBan}}data-action='openConversation' data-memberID='{{id}}' data-conID='{{conID}}'{{/isBan}}> <div class='ipsPhotoPanel ipsPhotoPanel_tiny'>  <span class='chatbox_one_avatar'>   <i class='fa fa-circle ipsOnlineStatus_online cbMemOnline {{^isOnline}}ipsHide{{/isOnline}}'></i>   <span class='ipsUserPhoto ipsUserPhoto_tiny'><img src='{{photo}}'></span>  </span>  <div>   <strong>{{{name}}}</strong><br>   <span class='ipsType_light'>{{{extra}}}</span>  </div> </div></li>");ips.templates.set('chatbox.search.mem',"  <li class='ipsAutocompleteMenu_item ipsClearfix' data-value=\"{{value}}\" role='option' role='listitem'>  <div class='ipsPhotoPanel ipsPhotoPanel_tiny'>   <span class='chatbox_one_avatar'>    <i class='fa fa-circle ipsOnlineStatus_online cbMemOnline {{^isOnline}}ipsHide{{/isOnline}}'></i>    <span class='ipsUserPhoto ipsUserPhoto_tiny'><img src='{{photo}}'></span>   </span>   <div>    <strong>{{{name}}}</strong><br>    <span class='ipsType_light'>{{{extra}}}</span>   </div>  </div> </li>");ips.templates.set('chatbox.newcon.notify'," <div data-role='newNotification'> <div class='ipsPhotoPanel ipsPhotoPanel_tiny' data-conID='{{{id}}}'>  <span class='ipsUserPhoto ipsUserPhoto_tiny'><img src='{{{icon}}}'></span>  <div class='ipsClearfix'>   <span class='ipsPos_left'><b>{{{title}}}</b></span>   {{#time}}<span class='ipsPos_right ipsType_light ipsType_small'>{{time}}</span>{{/time}}   {{#lastMsg}}<br><span class='cbLastMSG ipsType_small'>{{{lastMsg}}}</span>{{/lastMsg}}  </div> </div></div>");ips.templates.set('chatbox.upload.file',"  <div class='cbUploadedIMG ipsAttach ipsImageAttach' id='{{id}}' data-role='file' data-fileid='{{id}}' data-fullsizeurl='{{imagesrc}}' data-thumbnailurl='{{thumbnail}}' data-fileType='image'>  <ul class='ipsList_inline ipsImageAttach_controls'>   <li class='ipsPos_right' data-role='deleteFileWrapper'>    <input type='hidden' name='{{field_name}}_keep[{{id}}]' value='1'>    <a href='#' data-role='deleteFile' class='ipsButton ipsButton_verySmall ipsButton_light' data-ipsTooltip title='{{#lang}}removeScreenshot{{/lang}}'><i class='fa fa-times'></i></a>   </li>  </ul>  <label for='{{field_name}}_primary_screenshot_{{id}}' class='ipsCursor_pointer'>   <div class='ipsImageAttach_thumb ipsType_center' data-role='preview' data-grid-ratio='65' {{#thumb}}style='background-image: url( {{thumbnail_for_css}} )'{{/thumb}}>    {{#status}}     <span class='ipsImageAttach_status ipsType_light' data-role='status'>{{{status}}}</span>     <span class='ipsAttachment_progress'><span data-role='progressbar'></span></span>    {{/status}}    {{#thumb}}     {{{thumb}}}    {{/thumb}}    <i class='fa fa-music ipsType_large musicType' {{#thumb}}style='display: none'{{/thumb}}></i>   </div>  </label> </div>");ips.templates.set('chatbox.upload.fileWrapper',"  <div>{{{content}}}</div>");ips.templates.set('chatbox.emoticons'," <div class='ipsMenu ipsMenu_wide' id='{{id}}_menu' style='display: none' data-editorID='{{editor}}' data-controller='chatbox.emoticons'> <div class='ipsMenu_headerBar'>  <p class='ipsType_reset ipsPos_right'>   <a href='#' class='ipsType_blendLinks ipsHide' data-role='categoryTrigger' data-ipsMenu data-ipsMenu-appendTo='#{{id}}_menu' id='{{id}}_more'>{{#lang}}emoticonCategories{{/lang}} <i class='fa fa-caret-down'></i></a>  </p>  <h4 class='ipsType_sectionHead'>{{#lang}}emoji{{/lang}}</h4>  <ul data-role='categoryMenu' class='ipsMenu ipsMenu_auto ipsCursor_pointer' id='{{id}}_more_menu' role='menu' style='display: none'>  </ul> </div> <div class='ipsMenu_innerContent ipsEmoticons_content'>  <div class='ipsEmpty ipsType_center ipsEmoticons_contentLoading' data-role='emojiLoading'>   {{#lang}}loading{{/lang}}...  </div> </div> <div class='ipsMenu_footerBar ipsHide'>  <input type='text' data-role='emoticonSearch' class='ipsField_fullWidth' placeholder='{{#lang}}emoticonFind{{/lang}}'> </div></div>");;